<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <title>SuNT&#39;s Blog | AI in Practical</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="This is meta description">
  <meta name="author" content="SuNT">
  <meta name="generator" content="Hugo 0.68.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/slick/slick.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/themify-icons/themify-icons.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/venobox/venobox.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/css/override.css">
  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://tiensu.github.io/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://tiensu.github.io/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://tiensu.github.io/images/favicon.png " type="image/x-icon">

  <!-- google analitycs -->
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'Your ID', 'auto');
    ga('send', 'pageview');
  </script>

</head><body>
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0">
      <a class="navbar-brand mobile-view" href="https://tiensu.github.io/"><img class="img-fluid"
          src="https://tiensu.github.io/images/logo3.jpg" alt="SuNT&#39;s Blog | AI in Practical"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu h3"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <div class="desktop-view">
          <ul class="navbar-nav mr-auto">
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.facebook.com/tiensunguyen2103"><i class="ti-facebook"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.linkedin.com/in/su-nguyen-tien-aws%C2%AE-5ba74ba6/"><i class="ti-linkedin"></i></a>
            </li>
            
          </ul>
        </div>

        <a class="navbar-brand mx-auto desktop-view" href="https://tiensu.github.io/"><img class="img-fluid"
            src="https://tiensu.github.io/images/logo3.jpg" alt="SuNT&#39;s Blog | AI in Practical"></a>

        <ul class="navbar-nav">
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://tiensu.github.io/about">About</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://tiensu.github.io/blog">Post</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://tiensu.github.io/contact">Contact</a>
          </li>
          
          
        </ul>

        
        <!-- search -->
        <div class="search pl-lg-4">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://tiensu.github.io//search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        

        
      </div>
    </nav>
  </div>
  <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
      document.querySelectorAll("mjx-container").forEach(function(x){
        x.parentElement.classList += 'has-jax'})
    });

</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</header>
<!-- /navigation -->

<section class="section-sm">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        
        <a href="/categories/machine-learning"
          class="text-primary">Machine Learning</a>
        
        <a href="/categories/xgboost"
          class="text-primary">X g boost</a>
        
        <h2>XGBoost - Bài 12: Tuning số lượng và kích thước của Decision Tree</h2>
        <div class="mb-3 post-meta">
          <span>By SuNT</span>
          
          <span class="border-bottom border-primary px-2 mx-1"></span>
          <span>09 October 2020</span>
          
        </div>
        
        <img src="https://tiensu.github.io/images/featured-post/xgboost_n_estimator.png" class="img-fluid w-100 mb-4" alt="XGBoost - Bài 12: Tuning số lượng và kích thước của Decision Tree">
        
        <div class="content mb-5">
          <p>Ý tưởng cơ bản của thuật toán <code>Gradient Boosting</code> là lần lượt thêm các <code>decision trees</code> nối tiếp nhau. Tree thêm vào sau sẽ <code>cố gắng</code> giải quyết những sai sót của tree trước đó. Câu hỏi đặt ra là bao nhiêu trees (<em>weak learner</em> hay <em>estimators</em>) là đủ?</p>
<p>Trong bài nãy, hãy cùng nhau tìm hiều cách lựa chọn số lượng và kích thước của các trees phù hợp với từng bài toán của các bạn.</p>
<p><strong>1. Tune số lượng của <code>decision tree</code></strong></p>
<p>Thông thường khi sử dụng GBM, ta thường chọn số lượng trees tương đối nhỏ. Có thể là vài chục, vài trăm, hoặc vài nghìn. Nguyên nhân có lẽ là vì tăng số lượng trees lên nhiều hơn, hiệu năng của model cũng không tăng, thậm chí còn giảm đi so với khi sử dụng số lượng trees ít hơn.</p>
<p>Mình sẽ sử dụng <a href="https://www.kaggle.com/c/otto-group-product-classification-challenge/data">Otto dataset</a> để minh họa việc tuning số lượng trees. Ở đây mình sử dụng 10-fold cross-validation, số lượng trees trong khoảng [50, 400, 50] -&gt; Có 80 models được train.</p>
<p>Số lượng của trees được chỉ ra bởi giá trị của tham số <code>n_estimators</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># XGBoost on Otto dataset, Tune n_estimators</span>
<span style="color:#f92672">from</span> pandas <span style="color:#f92672">import</span> read_csv
<span style="color:#f92672">from</span> xgboost <span style="color:#f92672">import</span> XGBClassifier
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> GridSearchCV
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> StratifiedKFold
<span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> LabelEncoder
<span style="color:#f92672">import</span> matplotlib
matplotlib<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#39;Agg&#39;</span>)
<span style="color:#f92672">from</span> matplotlib <span style="color:#f92672">import</span> pyplot

<span style="color:#75715e"># load data</span>
data <span style="color:#f92672">=</span> read_csv(<span style="color:#e6db74">&#39;train.csv&#39;</span>)
dataset <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>values

<span style="color:#75715e"># split data into X and y</span>
X <span style="color:#f92672">=</span> dataset[:,<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">94</span>]
y <span style="color:#f92672">=</span> dataset[:,<span style="color:#ae81ff">94</span>]

<span style="color:#75715e"># encode string class values as integers</span>
label_encoded_y <span style="color:#f92672">=</span> LabelEncoder()<span style="color:#f92672">.</span>fit_transform(y)

<span style="color:#75715e"># grid search</span>
model <span style="color:#f92672">=</span> XGBClassifier()
n_estimators <span style="color:#f92672">=</span> range(<span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">400</span>, <span style="color:#ae81ff">50</span>)
param_grid <span style="color:#f92672">=</span> dict(n_estimators<span style="color:#f92672">=</span>n_estimators)
kfold <span style="color:#f92672">=</span> StratifiedKFold(n_splits<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, shuffle<span style="color:#f92672">=</span>True, random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>)
grid_search <span style="color:#f92672">=</span> GridSearchCV(model, param_grid, scoring<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;accuracy&#34;</span>, n_jobs<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>, cv<span style="color:#f92672">=</span>kfold, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
grid_result <span style="color:#f92672">=</span> grid_search<span style="color:#f92672">.</span>fit(X, label_encoded_y)

<span style="color:#75715e"># summarize results</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Best: </span><span style="color:#e6db74">%f</span><span style="color:#e6db74"> using </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (grid_result<span style="color:#f92672">.</span>best_score_, grid_result<span style="color:#f92672">.</span>best_params_))
means <span style="color:#f92672">=</span> grid_result<span style="color:#f92672">.</span>cv_results_[<span style="color:#e6db74">&#39;mean_test_score&#39;</span>]
stds <span style="color:#f92672">=</span> grid_result<span style="color:#f92672">.</span>cv_results_[<span style="color:#e6db74">&#39;std_test_score&#39;</span>]
params <span style="color:#f92672">=</span> grid_result<span style="color:#f92672">.</span>cv_results_[<span style="color:#e6db74">&#39;params&#39;</span>]
<span style="color:#66d9ef">for</span> mean, stdev, param <span style="color:#f92672">in</span> zip(means, stds, params):
	<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">%f</span><span style="color:#e6db74">) with: </span><span style="color:#e6db74">%r</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (mean, stdev, param))

<span style="color:#75715e"># plot</span>
pyplot<span style="color:#f92672">.</span>errorbar(n_estimators, means, yerr<span style="color:#f92672">=</span>stds)
pyplot<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#34;XGBoost n_estimators vs accuracy&#34;</span>)
pyplot<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;n_estimators&#39;</span>)
pyplot<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;accuracy&#39;</span>)
pyplot<span style="color:#f92672">.</span>savefig(<span style="color:#e6db74">&#39;_estimators.png&#39;</span>)
</code></pre></div><p>Kết quả:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Best: <span style="color:#f92672">-</span><span style="color:#ae81ff">0.001155</span> using {<span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">100</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001160</span> (<span style="color:#ae81ff">0.001059</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">50</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001155</span> (<span style="color:#ae81ff">0.001053</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">100</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001156</span> (<span style="color:#ae81ff">0.001054</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">150</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001155</span> (<span style="color:#ae81ff">0.001054</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">200</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001155</span> (<span style="color:#ae81ff">0.001054</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">250</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001155</span> (<span style="color:#ae81ff">0.001054</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">300</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001155</span> (<span style="color:#ae81ff">0.001054</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">350</span>}
</code></pre></div><p>Số lượng trees phù hợp nhất là 100, <code>neg_log_loss</code> đạt được tại đó là -0.001055. Hiệu năng của model không được cải thiện khi tăng số lượng trees từ 100 lên 350.</p>
<p>Đồ thị bên dưới thể hiện mối quan hệ giữa số lượng trees và <code>inverted logarihmic</code>:</p>


    <div style="text-align:center">
        <img style="height:auto" src="/images/post/n_estimators.png">
    </div>


<p><strong>2. Tune kích thước của <code>decision tree</code></strong></p>
<p>Kích thước của tree hay còn gọi là số lớp (<em>layers</em>) hay độ sâu (<em>depth</em>) của tree đó. Nếu tree quá nông (<em>shallow</em>) sẽ dẫn đến <code>underfitting</code> vì model chỉ học được rất ít chi tiết từ dữ liệu. Ngược lại, tree quá sâu (<em>deep</em>) thì model lại học quá nhiều chi tiết từ dữ liệu -&gt; <code>overfitting</code>.</p>
<p>Kích thước của tree được chỉ ra bởi giá trị của tham số <code>max_depth</code>. Ta sẽ thử <code>grid-seach</code> tham số này theo phạm vi [1, 11, 2].</p>
<p>Code đầy đủ như bê dưới:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># XGBoost on Otto dataset, Tune max_depth</span>
<span style="color:#f92672">from</span> pandas <span style="color:#f92672">import</span> read_csv
<span style="color:#f92672">from</span> xgboost <span style="color:#f92672">import</span> XGBClassifier
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> GridSearchCV
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> StratifiedKFold
<span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> LabelEncoder
<span style="color:#f92672">import</span> matplotlib
matplotlib<span style="color:#f92672">.</span>use(<span style="color:#960050;background-color:#1e0010">✬</span>Agg<span style="color:#960050;background-color:#1e0010">✬</span>)
<span style="color:#f92672">from</span> matplotlib <span style="color:#f92672">import</span> pyplot

<span style="color:#75715e"># load data</span>
data <span style="color:#f92672">=</span> read_csv(<span style="color:#e6db74">&#39;train.csv&#39;</span>)
dataset <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>values

<span style="color:#75715e"># split data into X and y</span>
X <span style="color:#f92672">=</span> dataset[:,<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">94</span>]
y <span style="color:#f92672">=</span> dataset[:,<span style="color:#ae81ff">94</span>]

<span style="color:#75715e"># encode string class values as integers</span>
label_encoded_y <span style="color:#f92672">=</span> LabelEncoder()<span style="color:#f92672">.</span>fit_transform(y)

<span style="color:#75715e"># grid search</span>
model <span style="color:#f92672">=</span> XGBClassifier()
max_depth <span style="color:#f92672">=</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">2</span>)
<span style="color:#66d9ef">print</span>(max_depth)
param_grid <span style="color:#f92672">=</span> dict(max_depth<span style="color:#f92672">=</span>max_depth)
kfold <span style="color:#f92672">=</span> StratifiedKFold(n_splits<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, shuffle<span style="color:#f92672">=</span>True, random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>)
grid_search <span style="color:#f92672">=</span> GridSearchCV(model, param_grid, scoring<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;accuracy&#34;</span>, n_jobs<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>, cv<span style="color:#f92672">=</span>kfold, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
grid_result <span style="color:#f92672">=</span> grid_search<span style="color:#f92672">.</span>fit(X, label_encoded_y)

<span style="color:#75715e"># summarize results</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Best: </span><span style="color:#e6db74">%f</span><span style="color:#e6db74"> using </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (grid_result<span style="color:#f92672">.</span>best_score_, grid_result<span style="color:#f92672">.</span>best_params_))
means <span style="color:#f92672">=</span> grid_result<span style="color:#f92672">.</span>cv_results_[<span style="color:#e6db74">&#39;mean_test_score&#39;</span>]
stds <span style="color:#f92672">=</span> grid_result<span style="color:#f92672">.</span>cv_results_[<span style="color:#e6db74">&#39;std_test_score&#39;</span>]
params <span style="color:#f92672">=</span> grid_result<span style="color:#f92672">.</span>cv_results_[<span style="color:#e6db74">&#39;params&#39;</span>]
<span style="color:#66d9ef">for</span> mean, stdev, param <span style="color:#f92672">in</span> zip(means, stds, params):
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">%f</span><span style="color:#e6db74">) with: </span><span style="color:#e6db74">%r</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (mean, stdev, param))

<span style="color:#75715e"># plot</span>
pyplot<span style="color:#f92672">.</span>errorbar(max_depth, means, yerr<span style="color:#f92672">=</span>stds)
pyplot<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#34;XGBoost max_depth vs accuracy&#34;</span>)
pyplot<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;max_depth&#39;</span>)
pyplot<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;accuracy&#39;</span>)
pyplot<span style="color:#f92672">.</span>savefig(<span style="color:#e6db74">&#39;max_depth.png&#39;</span>)
</code></pre></div><p>Kết quả:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Fitting <span style="color:#ae81ff">10</span> folds <span style="color:#66d9ef">for</span> each of <span style="color:#ae81ff">5</span> candidates, totalling <span style="color:#ae81ff">50</span> fits
[Parallel(n_jobs<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)]: Using backend LokyBackend <span style="color:#66d9ef">with</span> <span style="color:#ae81ff">12</span> concurrent workers<span style="color:#f92672">.</span>
[Parallel(n_jobs<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)]: Done  <span style="color:#ae81ff">26</span> tasks      <span style="color:#f92672">|</span> elapsed:  <span style="color:#ae81ff">5.0</span>min
[Parallel(n_jobs<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)]: Done  <span style="color:#ae81ff">50</span> out of  <span style="color:#ae81ff">50</span> <span style="color:#f92672">|</span> elapsed:  <span style="color:#ae81ff">7.8</span>min finished
Best: <span style="color:#f92672">-</span><span style="color:#ae81ff">0.001136</span> using {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">5</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001319</span> (<span style="color:#ae81ff">0.001100</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">1</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001153</span> (<span style="color:#ae81ff">0.001066</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">3</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001136</span> (<span style="color:#ae81ff">0.001077</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">5</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001150</span> (<span style="color:#ae81ff">0.001063</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">7</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001150</span> (<span style="color:#ae81ff">0.001063</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">9</span>}
</code></pre></div><p>Quan sát ouput, ta thấy rằng <code>max_depth</code> = 5 cho kết quả tốt nhất. Tăng giá trị này lên 7 hoặc 9, hiệu năng của model không những không được cải thiện mà còn kém đi.</p>
<p>Đồ thị thể hiện mối quan hệ của kích thước tree và <code>neg_log_loss</code>.</p>


    <div style="text-align:center">
        <img style="height:auto" src="/images/post/max_depth.png">
    </div>


<p><strong>3. Tune đồng thời số lượng và kích thước của <code>decision tree</code></strong></p>
<p>Có một mối liên hệ giữa số lượng và kích thước của mỗi tree. Nhiều tree hơn thì kích thước của mỗi tree sẽ nhỏ hơn. Ngược lại, ít tree hơn thì kích thước của mỗi tree sẽ lớn hơn.</p>
<p>Để tìm ra cặp giá trị (n_estimators, max_depth) phù hợp, ta sẽ thử grid-search như sau:</p>
<ul>
<li>n_estimators: (50, 100, 150, 200)</li>
<li>max_depth: (2, 4, 6, 8)</li>
<li>10-fold cross-validation
-&gt; 4x4x10 = 160 models</li>
</ul>
<p>Code đầy đủ bên dưới:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># XGBoost on Otto dataset, Tune n_estimators and max_depth</span>
<span style="color:#f92672">from</span> pandas <span style="color:#f92672">import</span> read_csv
<span style="color:#f92672">from</span> xgboost <span style="color:#f92672">import</span> XGBClassifier
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> GridSearchCV
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> StratifiedKFold
<span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> LabelEncoder
<span style="color:#f92672">import</span> matplotlib
matplotlib<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#39;Agg&#39;</span>)
<span style="color:#f92672">from</span> matplotlib <span style="color:#f92672">import</span> pyplot
<span style="color:#f92672">import</span> numpy

<span style="color:#75715e"># load data</span>
data <span style="color:#f92672">=</span> read_csv(<span style="color:#e6db74">&#39;train.csv&#39;</span>)
dataset <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>values

<span style="color:#75715e"># split data into X and y</span>
X <span style="color:#f92672">=</span> dataset[:,<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">94</span>]
y <span style="color:#f92672">=</span> dataset[:,<span style="color:#ae81ff">94</span>]

<span style="color:#75715e"># encode string class values as integers</span>
label_encoded_y <span style="color:#f92672">=</span> LabelEncoder()<span style="color:#f92672">.</span>fit_transform(y)

<span style="color:#75715e"># grid search</span>
model <span style="color:#f92672">=</span> XGBClassifier()
n_estimators <span style="color:#f92672">=</span> [<span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">150</span>, <span style="color:#ae81ff">200</span>]
max_depth <span style="color:#f92672">=</span> [<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">8</span>]
<span style="color:#66d9ef">print</span>(max_depth)
param_grid <span style="color:#f92672">=</span> dict(max_depth<span style="color:#f92672">=</span>max_depth, n_estimators<span style="color:#f92672">=</span>n_estimators)
kfold <span style="color:#f92672">=</span> StratifiedKFold(n_splits<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, shuffle<span style="color:#f92672">=</span>True, random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>)
grid_search <span style="color:#f92672">=</span> GridSearchCV(model, param_grid, scoring<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;accuracy&#34;</span>, n_jobs<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>, cv<span style="color:#f92672">=</span>kfold, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
grid_result <span style="color:#f92672">=</span> grid_search<span style="color:#f92672">.</span>fit(X, label_encoded_y)

<span style="color:#75715e"># summarize results</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Best: </span><span style="color:#e6db74">%f</span><span style="color:#e6db74"> using </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (grid_result<span style="color:#f92672">.</span>best_score_, grid_result<span style="color:#f92672">.</span>best_params_))
means <span style="color:#f92672">=</span> grid_result<span style="color:#f92672">.</span>cv_results_[<span style="color:#e6db74">&#39;mean_test_score&#39;</span>]
stds <span style="color:#f92672">=</span> grid_result<span style="color:#f92672">.</span>cv_results_[<span style="color:#e6db74">&#39;std_test_score&#39;</span>]
params <span style="color:#f92672">=</span> grid_result<span style="color:#f92672">.</span>cv_results_[<span style="color:#e6db74">&#39;params&#39;</span>]
<span style="color:#66d9ef">for</span> mean, stdev, param <span style="color:#f92672">in</span> zip(means, stds, params):
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">%f</span><span style="color:#e6db74">) with: </span><span style="color:#e6db74">%r</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (mean, stdev, param))

<span style="color:#75715e"># plot results</span>
scores <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>array(means)<span style="color:#f92672">.</span>reshape(len(max_depth), len(n_estimators))
<span style="color:#66d9ef">for</span> i, value <span style="color:#f92672">in</span> enumerate(max_depth):
pyplot<span style="color:#f92672">.</span>plot(n_estimators, scores[i], label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;depth: &#39;</span> <span style="color:#f92672">+</span> str(value))
pyplot<span style="color:#f92672">.</span>legend()
pyplot<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;n_estimators&#39;</span>)
pyplot<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;accuracy&#39;</span>)
pyplot<span style="color:#f92672">.</span>savefig(<span style="color:#e6db74">&#39;n_estimators_vs_max_depth.png&#39;</span>)
</code></pre></div><p>Kết quả:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Best: <span style="color:#f92672">-</span><span style="color:#ae81ff">0.001131</span> using {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">100</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001266</span> (<span style="color:#ae81ff">0.001112</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">50</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001249</span> (<span style="color:#ae81ff">0.001101</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">100</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001248</span> (<span style="color:#ae81ff">0.001101</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">150</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001247</span> (<span style="color:#ae81ff">0.001100</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">200</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001141</span> (<span style="color:#ae81ff">0.001094</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">50</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001131</span> (<span style="color:#ae81ff">0.001088</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">100</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001132</span> (<span style="color:#ae81ff">0.001089</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">150</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001132</span> (<span style="color:#ae81ff">0.001089</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">200</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001160</span> (<span style="color:#ae81ff">0.001059</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">6</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">50</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001155</span> (<span style="color:#ae81ff">0.001053</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">6</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">100</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001156</span> (<span style="color:#ae81ff">0.001054</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">6</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">150</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001155</span> (<span style="color:#ae81ff">0.001054</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">6</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">200</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001155</span> (<span style="color:#ae81ff">0.001068</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">50</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001150</span> (<span style="color:#ae81ff">0.001063</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">100</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001150</span> (<span style="color:#ae81ff">0.001064</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">150</span>}
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.001150</span> (<span style="color:#ae81ff">0.001064</span>) <span style="color:#66d9ef">with</span>: {<span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">200</span>}
</code></pre></div><p>Từ kết quả ta thấy kết quả tốt nhất đạt được tại <code>max_depth</code>=4 và <code>n_estimators</code>=100, tương tự như kết quả của 2 lần tuning riêng rẽ 2 tham số ở bên trên.</p>
<p>Đồ thị thể hiện mối quan hê của mỗi <code>max_depth</code> với các giá trị của <code>n_estimators</code>.</p>


    <div style="text-align:center">
        <img style="height:auto" src="/images/post/n_estimators_vs_max_depth.png">
    </div>


<p>Kết quả thể hiện trên đồ thị cũng minh họa cho nhận định về mối quan hệ giữa số lượng và kích thước của tree mà ta đã nói bên trên.</p>
<p><strong>6. Kết luận</strong></p>
<p>Qua bài viết này, chúng ta đã biết cách tuning XGBoost model, sử dụng phương pháp <code>grid-search</code> (<em>hỗ trợ bởi thư viện scikit-learn</em>) để tìm được số lượng và kích thước của trees phù hợp với bài toán đặt ra ban đầu. Ngoài phương pháp này, còn có 1 phương pháp khác cũng rất hiệu quả là <code>bayes</code> (sử dụng định luật <code>bayes</code>). Phương pháp này thước được các ông lớn AWS, Google, &hellip; sử dụng trong các dịch vụ về AI của họ.</p>
<p>Bài viết tiếp theo chúng ta sẽ tiếp tục tune <code>learning_rate</code> đồng thời với số lượng của tree trong XGboost model. Hãy cùng đón đọc! :)</p>
<p><em>Toàn bộ source code của bài này các bạn có thể tham khảo trên github cá nhân của mình tại <a href="https://github.com/tiensu/xgboost-algorithm/tree/master/tune_number_tree_and_depth">github.</a></em></p>
<p>Bài viết có tham khảo tại <a href="https://machinelearningmastery.com/XGBoost-with-python/">tham khảo</a>.</p>

        </div>

        
        
      </div>
    </div>
  </div>
</section>



<footer>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 text-center mb-5">
        <a href="https://tiensu.github.io/"><img src="https://tiensu.github.io/images/logo3.jpg" alt="SuNT&#39;s Blog | AI in Practical" style="height: auto"></a>
      </div>
               
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Contact Me</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="tel:0869644890"><i
                class="ti-mobile mr-3 text-primary"></i>0869644890</a></li>
          
                     
          <li class="mb-3"><i class="ti-location-pin mr-3 text-primary"></i>Hanoi, Vietnam</li>
          
                     
          <li class="mb-3"><a class="text-dark" href="mailto:tiensunguyen2103@gmail.com"><i
                class="ti-email mr-3 text-primary"></i>tiensunguyen2103@gmail.com</a>
          
          </li>
        </ul>
      </div>
      
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Social Contacts</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://www.facebook.com/tiensunguyen2103">Facebook</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://www.linkedin.com/in/su-nguyen-tien-aws%C2%AE-5ba74ba6/">Linkedin</a></li>
          
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Categories</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><a class="text-dark"
              href="/categories/algorithm-optimization">Algorithm Optimization</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/autoencoder">Autoencoder</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/cnn">Cnn</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/data-driff">Data driff</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/data-science">Data Science</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/deep-learning">Deep Learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/docker">Docker</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/ebook">Ebook</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/ensemble-learning">Ensemble Learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/face-recognition">Face recognition</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/image-classification">Image classification</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/kubernetes">Kubernetes</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/lstm">Lstm</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/machine-learning">Machine Learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/mlops">Mlops</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/neural-network">Neural Network</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/one-shot-learning">One shot learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/project-management">Project Management</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/rnn">Rnn</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/scalability">Scalability</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/siamese-network">Siamese network</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/text-classification">Text Classification</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/xgboost">Xgboost</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Quick Links</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://tiensu.github.io/about">About</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://tiensu.github.io/blog">Post</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://tiensu.github.io/contact">Contact</a></li>
          
        </ul>
      </div>
      <div class="col-12 border-top py-4 text-center">
        | copyright © 2021 <a href="tiensu.github.io">SuNT</a>. All Rights Reserved |
      </div>
    </div>
  </div>
</footer>

<script>
  var indexURL = "https://tiensu.github.io/index.json"
</script>

<!-- JS Plugins -->

<script src="https://tiensu.github.io/plugins/jQuery/jquery.min.js"></script>

<script src="https://tiensu.github.io/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://tiensu.github.io/plugins/slick/slick.min.js"></script>

<script src="https://tiensu.github.io/plugins/venobox/venobox.min.js"></script>

<script src="https://tiensu.github.io/plugins/search/fuse.min.js"></script>

<script src="https://tiensu.github.io/plugins/search/mark.js"></script>

<script src="https://tiensu.github.io/plugins/search/search.js"></script>

<!-- Main Script -->

<script src="https://tiensu.github.io/js/script.min.js"></script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js"></script>
<div id="js-cookie-box" class="cookie-box cookie-box-hide">
	This site uses cookies. By continuing to use this website, you agree to their use. <span id="js-cookie-button" class="btn btn-sm btn-primary ml-2">I Accept</span>
</div>
<script>
	(function ($) {
		const cookieBox = document.getElementById('js-cookie-box');
		const cookieButton = document.getElementById('js-cookie-button');
		if (!Cookies.get('cookie-box')) {
			cookieBox.classList.remove('cookie-box-hide');
			cookieButton.onclick = function () {
				Cookies.set('cookie-box', true, {
					expires:  2 
				});
				cookieBox.classList.add('cookie-box-hide');
			};
		}
	})(jQuery);
</script>


<style>
.cookie-box {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  text-align: center;
  z-index: 9999;
  padding: 1rem 2rem;
  background: rgb(71, 71, 71);
  transition: all .75s cubic-bezier(.19, 1, .22, 1);
  color: #fdfdfd;
}

.cookie-box-hide {
  display: none;
}
</style>
</body>
</html>