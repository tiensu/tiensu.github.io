<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <title>SuNT&#39;s Blog | AI in Practical</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="This is meta description">
  <meta name="author" content="SuNT">
  <meta name="generator" content="Hugo 0.68.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/slick/slick.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/themify-icons/themify-icons.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/venobox/venobox.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/css/override.css">
  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://tiensu.github.io/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://tiensu.github.io/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://tiensu.github.io/images/favicon.png " type="image/x-icon">

  <!-- google analitycs -->
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'Your ID', 'auto');
    ga('send', 'pageview');
  </script>

</head><body>
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0">
      <a class="navbar-brand mobile-view" href="https://tiensu.github.io/"><img class="img-fluid"
          src="https://tiensu.github.io/images/logo3.jpg" alt="SuNT&#39;s Blog | AI in Practical"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu h3"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <div class="desktop-view">
          <ul class="navbar-nav mr-auto">
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.facebook.com/tiensunguyen2103"><i class="ti-facebook"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.linkedin.com/in/su-nguyen-tien-aws%C2%AE-5ba74ba6/"><i class="ti-linkedin"></i></a>
            </li>
            
          </ul>
        </div>

        <a class="navbar-brand mx-auto desktop-view" href="https://tiensu.github.io/"><img class="img-fluid"
            src="https://tiensu.github.io/images/logo3.jpg" alt="SuNT&#39;s Blog | AI in Practical"></a>

        <ul class="navbar-nav">
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://tiensu.github.io/about">About</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://tiensu.github.io/blog">Post</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://tiensu.github.io/contact">Contact</a>
          </li>
          
          
        </ul>

        
        <!-- search -->
        <div class="search pl-lg-4">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://tiensu.github.io//search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        

        
      </div>
    </nav>
  </div>
  <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
      document.querySelectorAll("mjx-container").forEach(function(x){
        x.parentElement.classList += 'has-jax'})
    });

</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</header>
<!-- /navigation -->

<section class="section-sm">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        
        <a href="/categories/mlops"
          class="text-primary">M l ops</a>
        
        <a href="/categories/kubernetes"
          class="text-primary">Kubernetes</a>
        
        <a href="/categories/docker"
          class="text-primary">Docker</a>
        
        <h2>Tìm hiểu về Kubernetes và áp dụng vào bài toán AI - Phần 2: Kubernetes Job</h2>
        <div class="mb-3 post-meta">
          <span>By SuNT</span>
          
          <span class="border-bottom border-primary px-2 mx-1"></span>
          <span>22 January 2021</span>
          
        </div>
        
        <img src="https://tiensu.github.io/images/featured-post/kubernetes_job.png" class="img-fluid w-100 mb-4" alt="Tìm hiểu về Kubernetes và áp dụng vào bài toán AI - Phần 2: Kubernetes Job">
        
        <div class="content mb-5">
          <p>Trong bài trước, chúng ta đã tìm hiểu về Pod, cách tương tác với Pod và hạn chế của nó. Bài này, chúng ta sẽ làm việc với một thành phần ở mức <code>high level</code> hơn của Kubernetes, đó là Job. Cụ thể, mình sẽ cùng nhau tạo ra các Job để train model và thực hiện Batch Inference.</p>
<p><strong>1. Kubernetes Job là gì?</strong></p>
<p>Theo định nghĩa từ <a href="">trang chủ</a> của Kubernetes thì:</p>
<p><em><strong>A Job creates one or more Pods and will continue to retry execution of the Pods until a specified number of them successfully terminate. As pods successfully complete, the Job tracks the successful completions. When a specified number of successful completions is reached, the task (ie, Job) is complete. Deleting a Job will clean up the Pods it created.</strong></em></p>
<p>Hiểu một cách đơn giản thì Jobs chịu trách nhiệm quản lý một hoặc nhiều Pods để thực hiện một công việc nào đó. Trong quá trình làm việc, các Pods có thể chạy song song với nhau, và nếu một Pod bị chết thì Job sẽ tạo ra một Pod khác để thay thể. Job chỉ được coi là hoàn thành thì tất cả các Pod của nó hoàn thành. Khi xóa Job, các Pods được quản lý bởi nó cũng bị xóa theo.</p>
<p>Job rất phù hợp để chạy các tác vụ kiểu Batch, tức là các tác vụ mà chạy trong một khoảng thời gian nào đó rồi kết thúc. Trong AI, có khá nhiều tác vụ kiểu như vậy, có thể kể ra như Feature Engineering, Cross-Validation, Model Training, Batch Inference. Ví dụ, chúng ta tạo ra một Job để train một model, sau đó lưu model đó vào Storage. Một Job khác sẽ sử dụng model đó để thực hiện Batch Inference.</p>
<p><strong>2. Sử dụng Job cho các tác vụ AI</strong></p>
<p>Chúng ta sẽ thử tạo 2 Jobs:</p>
<ul>
<li>Job thứ nhất để train ML model, lưu model ra file trên AWS S3.</li>
<li>Job thứ hai sử dụng model đã trained để thực hiện Batch Inference.</li>
</ul>
<p>Hãy xem cấu trúc thư mục làm việc:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">kubernetes_job
<span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">├──</span> docker
<span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">├──</span> batch_inference<span style="color:#f92672">.</span>py
<span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">├──</span> Dockerfile
<span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">└──</span> train<span style="color:#f92672">.</span>py
<span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">└──</span> job
<span style="color:#960050;background-color:#1e0010">│</span>       <span style="color:#960050;background-color:#1e0010">├──</span> job<span style="color:#f92672">-</span>inference<span style="color:#f92672">.</span>yaml
<span style="color:#960050;background-color:#1e0010">│</span>       <span style="color:#960050;background-color:#1e0010">└──</span> job<span style="color:#f92672">-</span>train<span style="color:#f92672">.</span>yaml
</code></pre></div><p><em><strong>2.1 Code train &amp; inference model</strong></em></p>
<p>Tạo thư mục <code>docker</code> và copy 2 file <code>train.py</code> và <code>batch_inference.py</code> đã sử dụng trong các bài trước vào thư mục vừa tạo.
Sử a lại nội dung của file <code>train.py</code> như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> json
<span style="color:#f92672">import</span> os

<span style="color:#f92672">import</span> boto3
<span style="color:#f92672">from</span> joblib <span style="color:#f92672">import</span> dump
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">from</span> sklearn <span style="color:#f92672">import</span> ensemble
<span style="color:#f92672">from</span> sklearn <span style="color:#f92672">import</span> datasets
<span style="color:#f92672">from</span> sklearn.utils <span style="color:#f92672">import</span> shuffle
<span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> mean_squared_error


MODEL_DIR <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;MODEL_DIR&#34;</span>]
MODEL_FILE <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;MODEL_FILE&#34;</span>]
METADATA_FILE <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;METADATA_FILE&#34;</span>]
BUCKET_NAME <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;BUCKET_NAME&#34;</span>]
MODEL_PATH <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(MODEL_DIR, MODEL_FILE)
METADATA_PATH <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(MODEL_DIR, METADATA_FILE)


<span style="color:#75715e"># #############################################################################</span>
<span style="color:#75715e"># Load data</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Loading data...&#34;</span>)
boston <span style="color:#f92672">=</span> datasets<span style="color:#f92672">.</span>load_boston()

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Splitting data...&#34;</span>)
X, y <span style="color:#f92672">=</span> shuffle(boston<span style="color:#f92672">.</span>data, boston<span style="color:#f92672">.</span>target, random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>)
X <span style="color:#f92672">=</span> X<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>float32)
offset <span style="color:#f92672">=</span> int(X<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.9</span>)
X_train, y_train <span style="color:#f92672">=</span> X[:offset], y[:offset]
X_test, y_test <span style="color:#f92672">=</span> X[offset:], y[offset:]

<span style="color:#75715e"># #############################################################################</span>
<span style="color:#75715e"># Fit regression model</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Fitting model...&#34;</span>)
params <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">500</span>, <span style="color:#e6db74">&#39;max_depth&#39;</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;min_samples_split&#39;</span>: <span style="color:#ae81ff">2</span>,
          <span style="color:#e6db74">&#39;learning_rate&#39;</span>: <span style="color:#ae81ff">0.01</span>, <span style="color:#e6db74">&#39;loss&#39;</span>: <span style="color:#e6db74">&#39;ls&#39;</span>}
clf <span style="color:#f92672">=</span> ensemble<span style="color:#f92672">.</span>GradientBoostingRegressor(<span style="color:#f92672">**</span>params)

clf<span style="color:#f92672">.</span>fit(X_train, y_train)
train_mse <span style="color:#f92672">=</span> mean_squared_error(y_train, clf<span style="color:#f92672">.</span>predict(X_train))
test_mse <span style="color:#f92672">=</span> mean_squared_error(y_test, clf<span style="color:#f92672">.</span>predict(X_test))
metadata <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#34;train_mean_square_error&#34;</span>: train_mse,
    <span style="color:#e6db74">&#34;test_mean_square_error&#34;</span>: test_mse
}

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Serializing model to: {}&#34;</span><span style="color:#f92672">.</span>format(MODEL_PATH))
dump(clf, MODEL_PATH)

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Serializing metadata to: {}&#34;</span><span style="color:#f92672">.</span>format(METADATA_PATH))
<span style="color:#66d9ef">with</span> open(METADATA_PATH, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> outfile:  
    json<span style="color:#f92672">.</span>dump(metadata, outfile)

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Moving to S3&#34;</span>)
s3 <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;s3&#39;</span>)
s3<span style="color:#f92672">.</span>upload_file(MODEL_PATH, BUCKET_NAME, MODEL_FILE)
</code></pre></div><p>Sửa lại code của file <code>batch_inference.py</code> như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> os

<span style="color:#f92672">import</span> boto3
<span style="color:#f92672">from</span> joblib <span style="color:#f92672">import</span> load
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">from</span> sklearn <span style="color:#f92672">import</span> datasets
<span style="color:#f92672">from</span> sklearn.utils <span style="color:#f92672">import</span> shuffle


MODEL_DIR <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;MODEL_DIR&#34;</span>]
MODEL_FILE <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;MODEL_FILE&#34;</span>]
METADATA_FILE <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;METADATA_FILE&#34;</span>]
BUCKET_NAME <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;BUCKET_NAME&#34;</span>]
MODEL_PATH <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(MODEL_DIR, MODEL_FILE)
METADATA_PATH <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(MODEL_DIR, METADATA_FILE)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_model</span>():
    s3 <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>resource(<span style="color:#e6db74">&#39;s3&#39;</span>)
    <span style="color:#66d9ef">try</span>:
        s3<span style="color:#f92672">.</span>Bucket(BUCKET_NAME)<span style="color:#f92672">.</span>download_file(MODEL_FILE, MODEL_PATH)
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
        <span style="color:#66d9ef">if</span> e<span style="color:#f92672">.</span>response[<span style="color:#e6db74">&#39;Error&#39;</span>][<span style="color:#e6db74">&#39;Code&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;404&#34;</span>:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;The object does not exist.&#34;</span>)
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">raise</span>
    <span style="color:#66d9ef">return</span> load(MODEL_PATH)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_data</span>():
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Return data for inference.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Loading data...&#34;</span>)
    boston <span style="color:#f92672">=</span> datasets<span style="color:#f92672">.</span>load_boston()
    X, y <span style="color:#f92672">=</span> shuffle(boston<span style="color:#f92672">.</span>data, boston<span style="color:#f92672">.</span>target, random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>)
    X <span style="color:#f92672">=</span> X<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>float32)
    offset <span style="color:#f92672">=</span> int(X<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.9</span>)
    X_train, y_train <span style="color:#f92672">=</span> X[:offset], y[:offset]
    X_test, y_test <span style="color:#f92672">=</span> X[offset:], y[offset:]
    <span style="color:#66d9ef">return</span> X_test, y_test

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Running inference...&#34;</span>)
X, y <span style="color:#f92672">=</span> get_data()

<span style="color:#75715e"># #############################################################################</span>
<span style="color:#75715e"># Load model</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Loading model from: {}&#34;</span><span style="color:#f92672">.</span>format(MODEL_PATH))
clf <span style="color:#f92672">=</span> load_model()

<span style="color:#75715e"># #############################################################################</span>
<span style="color:#75715e"># Run inference</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Scoring observations...&#34;</span>)
y_pred <span style="color:#f92672">=</span> clf<span style="color:#f92672">.</span>predict(X)
<span style="color:#66d9ef">print</span>(y_pred)
</code></pre></div><p><em><strong>2.2 Tạo Docker Images</strong></em></p>
<ul>
<li>Tạo file Dokerfile</li>
</ul>
<p>Cũng trong cùng thư mục <code>docker</code>, tạo file Dockerfile với nội dung như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">FROM jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook
USER root
WORKDIR <span style="color:#f92672">/</span>docker
ADD <span style="color:#f92672">.</span> <span style="color:#f92672">/</span>docker

RUN pip install awscli joblib boto3
RUN mkdir <span style="color:#f92672">/</span>docker<span style="color:#f92672">/</span>model

<span style="color:#75715e"># Env variables</span>
ENV MODEL_DIR<span style="color:#f92672">=/</span>docker<span style="color:#f92672">/</span>model
ENV MODEL_FILE<span style="color:#f92672">=</span>clf<span style="color:#f92672">.</span>joblib
ENV METADATA_FILE<span style="color:#f92672">=</span>metadata<span style="color:#f92672">.</span>json
ENV BUCKET_NAME<span style="color:#f92672">=</span>kubernetes<span style="color:#f92672">-</span>job
</code></pre></div><ul>
<li>Build Docker Image này:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> docker build <span style="color:#f92672">-</span>t docker<span style="color:#f92672">-</span>ml <span style="color:#f92672">.</span>
Sending build context to Docker daemon  <span style="color:#ae81ff">6.656</span>kB
Step <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">10</span> : FROM jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook
 <span style="color:#f92672">---&gt;</span> c1a7c7ef5e27
Step <span style="color:#ae81ff">2</span><span style="color:#f92672">/</span><span style="color:#ae81ff">10</span> : USER root
 <span style="color:#f92672">---&gt;</span> Using cache
 <span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">0</span>c1dbc43bef8
Step <span style="color:#ae81ff">3</span><span style="color:#f92672">/</span><span style="color:#ae81ff">10</span> : WORKDIR <span style="color:#f92672">/</span>docker
 <span style="color:#f92672">---&gt;</span> Running <span style="color:#f92672">in</span> fdae735976d0
Removing intermediate container fdae735976d0
 <span style="color:#f92672">---&gt;</span> b795fe3bbd80
Step <span style="color:#ae81ff">4</span><span style="color:#f92672">/</span><span style="color:#ae81ff">10</span> : ADD <span style="color:#f92672">.</span> <span style="color:#f92672">/</span>docker
 <span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">16082</span>b6c9bda
Step <span style="color:#ae81ff">5</span><span style="color:#f92672">/</span><span style="color:#ae81ff">10</span> : RUN pip install awscli joblib boto3
 <span style="color:#f92672">---&gt;</span> Running <span style="color:#f92672">in</span> e4f9036ae9fc
Collecting awscli
  Downloading awscli<span style="color:#f92672">-</span><span style="color:#ae81ff">1.18</span><span style="color:#f92672">.</span><span style="color:#ae81ff">221</span><span style="color:#f92672">-</span>py2<span style="color:#f92672">.</span>py3<span style="color:#f92672">-</span>none<span style="color:#f92672">-</span>any<span style="color:#f92672">.</span>whl (<span style="color:#ae81ff">3.5</span> MB)
Requirement already satisfied: joblib <span style="color:#f92672">in</span> <span style="color:#f92672">/</span>opt<span style="color:#f92672">/</span>conda<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python3<span style="color:#f92672">.</span><span style="color:#ae81ff">8</span><span style="color:#f92672">/</span>site<span style="color:#f92672">-</span>packages (<span style="color:#ae81ff">1.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>)
Collecting boto3
  Downloading boto3<span style="color:#f92672">-</span><span style="color:#ae81ff">1.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">61</span><span style="color:#f92672">-</span>py2<span style="color:#f92672">.</span>py3<span style="color:#f92672">-</span>none<span style="color:#f92672">-</span>any<span style="color:#f92672">.</span>whl (<span style="color:#ae81ff">130</span> kB)
Collecting s3transfer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">0.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>
  Downloading s3transfer<span style="color:#f92672">-</span><span style="color:#ae81ff">0.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">-</span>py2<span style="color:#f92672">.</span>py3<span style="color:#f92672">-</span>none<span style="color:#f92672">-</span>any<span style="color:#f92672">.</span>whl (<span style="color:#ae81ff">69</span> kB)
Collecting botocore<span style="color:#f92672">==</span><span style="color:#ae81ff">1.19</span><span style="color:#f92672">.</span><span style="color:#ae81ff">61</span>
  Downloading botocore<span style="color:#f92672">-</span><span style="color:#ae81ff">1.19</span><span style="color:#f92672">.</span><span style="color:#ae81ff">61</span><span style="color:#f92672">-</span>py2<span style="color:#f92672">.</span>py3<span style="color:#f92672">-</span>none<span style="color:#f92672">-</span>any<span style="color:#f92672">.</span>whl (<span style="color:#ae81ff">7.2</span> MB)
Collecting PyYAML<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">5.4</span>,<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">3.10</span>
  Downloading PyYAML<span style="color:#f92672">-</span><span style="color:#ae81ff">5.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.</span>tar<span style="color:#f92672">.</span>gz (<span style="color:#ae81ff">269</span> kB)
Collecting colorama<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span>,<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">0.2</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>
  Downloading colorama<span style="color:#f92672">-</span><span style="color:#ae81ff">0.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">-</span>py2<span style="color:#f92672">.</span>py3<span style="color:#f92672">-</span>none<span style="color:#f92672">-</span>any<span style="color:#f92672">.</span>whl (<span style="color:#ae81ff">15</span> kB)
Collecting rsa<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">4.5</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">3.1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2</span>
  Downloading rsa<span style="color:#f92672">-</span><span style="color:#ae81ff">4.5</span><span style="color:#f92672">-</span>py2<span style="color:#f92672">.</span>py3<span style="color:#f92672">-</span>none<span style="color:#f92672">-</span>any<span style="color:#f92672">.</span>whl (<span style="color:#ae81ff">36</span> kB)
Collecting docutils<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0.16</span>,<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">0.10</span>
  Downloading docutils<span style="color:#f92672">-</span><span style="color:#ae81ff">0.15</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span>py3<span style="color:#f92672">-</span>none<span style="color:#f92672">-</span>any<span style="color:#f92672">.</span>whl (<span style="color:#ae81ff">547</span> kB)
Collecting jmespath<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">1.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">0.7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span>
  Downloading jmespath<span style="color:#f92672">-</span><span style="color:#ae81ff">0.10</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span>py2<span style="color:#f92672">.</span>py3<span style="color:#f92672">-</span>none<span style="color:#f92672">-</span>any<span style="color:#f92672">.</span>whl (<span style="color:#ae81ff">24</span> kB)
Requirement already satisfied: urllib3<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">1.27</span>,<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">1.25</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span> <span style="color:#f92672">in</span> <span style="color:#f92672">/</span>opt<span style="color:#f92672">/</span>conda<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python3<span style="color:#f92672">.</span><span style="color:#ae81ff">8</span><span style="color:#f92672">/</span>site<span style="color:#f92672">-</span>packages (<span style="color:#f92672">from</span> botocore<span style="color:#f92672">==</span><span style="color:#ae81ff">1.19</span><span style="color:#f92672">.</span><span style="color:#ae81ff">61</span><span style="color:#f92672">-&gt;</span>awscli) (<span style="color:#ae81ff">1.26</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span>)
Requirement already satisfied: python<span style="color:#f92672">-</span>dateutil<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">3.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">2.1</span> <span style="color:#f92672">in</span> <span style="color:#f92672">/</span>opt<span style="color:#f92672">/</span>conda<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python3<span style="color:#f92672">.</span><span style="color:#ae81ff">8</span><span style="color:#f92672">/</span>site<span style="color:#f92672">-</span>packages (<span style="color:#f92672">from</span> botocore<span style="color:#f92672">==</span><span style="color:#ae81ff">1.19</span><span style="color:#f92672">.</span><span style="color:#ae81ff">61</span><span style="color:#f92672">-&gt;</span>awscli) (<span style="color:#ae81ff">2.8</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span>)
Requirement already satisfied: six<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">1.5</span> <span style="color:#f92672">in</span> <span style="color:#f92672">/</span>opt<span style="color:#f92672">/</span>conda<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python3<span style="color:#f92672">.</span><span style="color:#ae81ff">8</span><span style="color:#f92672">/</span>site<span style="color:#f92672">-</span>packages (<span style="color:#f92672">from</span> python<span style="color:#f92672">-</span>dateutil<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">3.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">2.1</span><span style="color:#f92672">-&gt;</span>botocore<span style="color:#f92672">==</span><span style="color:#ae81ff">1.19</span><span style="color:#f92672">.</span><span style="color:#ae81ff">61</span><span style="color:#f92672">-&gt;</span>awscli) (<span style="color:#ae81ff">1.15</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>)
Collecting pyasn1<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">0.1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span>
  Downloading pyasn1<span style="color:#f92672">-</span><span style="color:#ae81ff">0.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">8</span><span style="color:#f92672">-</span>py2<span style="color:#f92672">.</span>py3<span style="color:#f92672">-</span>none<span style="color:#f92672">-</span>any<span style="color:#f92672">.</span>whl (<span style="color:#ae81ff">77</span> kB)
Building wheels <span style="color:#66d9ef">for</span> collected packages: PyYAML
  Building wheel <span style="color:#66d9ef">for</span> PyYAML (setup<span style="color:#f92672">.</span>py): started
  Building wheel <span style="color:#66d9ef">for</span> PyYAML (setup<span style="color:#f92672">.</span>py): finished <span style="color:#66d9ef">with</span> status <span style="color:#e6db74">&#39;done&#39;</span>
  Created wheel <span style="color:#66d9ef">for</span> PyYAML: filename<span style="color:#f92672">=</span>PyYAML<span style="color:#f92672">-</span><span style="color:#ae81ff">5.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>cp38<span style="color:#f92672">-</span>cp38<span style="color:#f92672">-</span>linux_x86_64<span style="color:#f92672">.</span>whl size<span style="color:#f92672">=</span><span style="color:#ae81ff">44618</span> sha256<span style="color:#f92672">=</span><span style="color:#ae81ff">421030371</span>a2f82fdfd722d0b032ce5b0c8d01e02a5ca379c9a0e2eea3a03fd78
  Stored <span style="color:#f92672">in</span> directory: <span style="color:#f92672">/</span>tmp<span style="color:#f92672">/</span>pip<span style="color:#f92672">-</span>ephem<span style="color:#f92672">-</span>wheel<span style="color:#f92672">-</span>cache<span style="color:#f92672">-</span>cs65titp<span style="color:#f92672">/</span>wheels<span style="color:#f92672">/</span><span style="color:#ae81ff">13</span><span style="color:#f92672">/</span><span style="color:#ae81ff">90</span><span style="color:#f92672">/</span>db<span style="color:#f92672">/</span><span style="color:#ae81ff">290</span>ab3a34f2ef0b5a0f89235dc2d40fea83e77de84ed2dc05c
Successfully built PyYAML
Installing collected packages: jmespath, pyasn1, botocore, s3transfer, rsa, PyYAML, docutils, colorama, boto3, awscli
  Attempting uninstall: PyYAML
    Found existing installation: PyYAML <span style="color:#ae81ff">5.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span>
    Uninstalling PyYAML<span style="color:#f92672">-</span><span style="color:#ae81ff">5.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span>:
      Successfully uninstalled PyYAML<span style="color:#f92672">-</span><span style="color:#ae81ff">5.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span>
Successfully installed PyYAML<span style="color:#f92672">-</span><span style="color:#ae81ff">5.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span> awscli<span style="color:#f92672">-</span><span style="color:#ae81ff">1.18</span><span style="color:#f92672">.</span><span style="color:#ae81ff">221</span> boto3<span style="color:#f92672">-</span><span style="color:#ae81ff">1.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">61</span> botocore<span style="color:#f92672">-</span><span style="color:#ae81ff">1.19</span><span style="color:#f92672">.</span><span style="color:#ae81ff">61</span> colorama<span style="color:#f92672">-</span><span style="color:#ae81ff">0.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span> docutils<span style="color:#f92672">-</span><span style="color:#ae81ff">0.15</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2</span> jmespath<span style="color:#f92672">-</span><span style="color:#ae81ff">0.10</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span> pyasn1<span style="color:#f92672">-</span><span style="color:#ae81ff">0.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">8</span> rsa<span style="color:#f92672">-</span><span style="color:#ae81ff">4.5</span> s3transfer<span style="color:#f92672">-</span><span style="color:#ae81ff">0.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span>
Removing intermediate container e4f9036ae9fc
 <span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">0</span>f7e7ec1c6a0
Step <span style="color:#ae81ff">6</span><span style="color:#f92672">/</span><span style="color:#ae81ff">10</span> : RUN mkdir <span style="color:#f92672">/</span>docker<span style="color:#f92672">/</span>model
 <span style="color:#f92672">---&gt;</span> Running <span style="color:#f92672">in</span> <span style="color:#ae81ff">7</span>f4c3bd5253a
Removing intermediate container <span style="color:#ae81ff">7</span>f4c3bd5253a
 <span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">0</span>b2c845fbb40
Step <span style="color:#ae81ff">7</span><span style="color:#f92672">/</span><span style="color:#ae81ff">10</span> : ENV MODEL_DIR<span style="color:#f92672">=/</span>docker<span style="color:#f92672">/</span>model
 <span style="color:#f92672">---&gt;</span> Running <span style="color:#f92672">in</span> <span style="color:#ae81ff">643</span>ef25a50eb
Removing intermediate container <span style="color:#ae81ff">643</span>ef25a50eb
 <span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">339</span>c22e0a4f9
Step <span style="color:#ae81ff">8</span><span style="color:#f92672">/</span><span style="color:#ae81ff">10</span> : ENV MODEL_FILE<span style="color:#f92672">=</span>clf<span style="color:#f92672">.</span>joblib
 <span style="color:#f92672">---&gt;</span> Running <span style="color:#f92672">in</span> d81f810dc092
Removing intermediate container d81f810dc092
 <span style="color:#f92672">---&gt;</span> cd7ecdc2f380
Step <span style="color:#ae81ff">9</span><span style="color:#f92672">/</span><span style="color:#ae81ff">10</span> : ENV METADATA_FILE<span style="color:#f92672">=</span>metadata<span style="color:#f92672">.</span>json
 <span style="color:#f92672">---&gt;</span> Running <span style="color:#f92672">in</span> <span style="color:#ae81ff">701460e9</span>b463
Removing intermediate container <span style="color:#ae81ff">701460e9</span>b463
 <span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">7646e477</span>d5a9
Step <span style="color:#ae81ff">10</span><span style="color:#f92672">/</span><span style="color:#ae81ff">10</span> : ENV BUCKET_NAME<span style="color:#f92672">=</span>kubernetes<span style="color:#f92672">-</span>job
 <span style="color:#f92672">---&gt;</span> Running <span style="color:#f92672">in</span> ce92e3cdbc3b
Removing intermediate container ce92e3cdbc3b
 <span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">31</span>d25c8be720
Successfully built <span style="color:#ae81ff">31</span>d25c8be720
Successfully tagged docker<span style="color:#f92672">-</span>ml:latest
</code></pre></div><ul>
<li>Push Docker Image lên Docker Hub:</li>
</ul>
<p>Sử dụng các lệnh sau để push Docker Image vừa build lên Docker Hub</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> docker tag docker<span style="color:#f92672">-</span>ml:latest tiensu<span style="color:#f92672">/</span>docker<span style="color:#f92672">-</span>ml:latest
<span style="color:#960050;background-color:#1e0010">$</span> docker push tiensu<span style="color:#f92672">/</span>docker<span style="color:#f92672">-</span>ml:latest
The push refers to repository [docker<span style="color:#f92672">.</span>io<span style="color:#f92672">/</span>tiensu<span style="color:#f92672">/</span>docker<span style="color:#f92672">-</span>ml]
<span style="color:#ae81ff">76</span>fba3826ca9: Pushed 
<span style="color:#ae81ff">59928</span>edb97b5: Pushed 
b5e012598fbb: Pushed 
c4e3257e6eb5: Pushed 
<span style="color:#ae81ff">5</span>f70bf18a086: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">6</span>f5a41ae77fd: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">5</span>a1b9a3f9355: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
b1d7816bac14: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
c91fed2d1998: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
cc70098d00e3: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">88727e93</span>cbac: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
cadaf24035f3: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">8</span>f170f4774e3: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">33</span>bd52db887f: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">21e5</span>dd010f50: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
ea370ab22368: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">421</span>d1408f872: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">18</span>fd1ca0de51: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">8</span>f01aab6d756: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
e18a1c4e1d31: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">8552</span>f27c3cd8: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">1</span>a4c57efcc23: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">94</span>b8fe888eac: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">02473</span>afd360b: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
dbf2c0f42a39: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
<span style="color:#ae81ff">9</span>f32931c9d28: Mounted <span style="color:#f92672">from</span> tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer 
latest: digest: sha256:<span style="color:#ae81ff">40678</span>bdd8d763129322db38be9f83bc70d1278b7836c7c7f4f4ac3ef6af20e5e size: <span style="color:#ae81ff">6582</span>
</code></pre></div><p><em><strong>2.3 Tạo Kubernetes Job để train ML model</strong></em></p>
<p>Tương tự như tạo Pod, để tạo Job ta cũng cần khai báo các thông tin cần thiết trong file cấu hình <code>job-train.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">apiVersion: batch<span style="color:#f92672">/</span>v1
kind: Job
metadata:
  name: job<span style="color:#f92672">-</span>train<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model
spec:
  template:
    spec:
      containers:
      <span style="color:#f92672">-</span> name: train<span style="color:#f92672">-</span>container
        imagePullPolicy: Always
        image: tiensu<span style="color:#f92672">/</span>docker<span style="color:#f92672">-</span>ml:latest
        command: [<span style="color:#e6db74">&#34;python3&#34;</span>,  <span style="color:#e6db74">&#34;train.py&#34;</span>]
        env:
        <span style="color:#f92672">-</span> name: AWS_ACCESS_KEY_ID
          value: <span style="color:#e6db74">&#34;&#34;</span>
        <span style="color:#f92672">-</span> name: AWS_SECRET_ACCESS_KEY
          value: <span style="color:#e6db74">&#34;&#34;</span>
      restartPolicy: Never
  backoffLimit: <span style="color:#ae81ff">0</span>
</code></pre></div><p>Một số thông tin như sau:</p>
<ul>
<li><strong>apiVersion</strong>: Phiên bản của <a href="https://kubernetes.io/docs/concepts/overview/kubernetes-api/#api-versioning">Kubernetes API</a>.</li>
<li><strong>kind</strong>: Loại tài nguyên của Kubernetes cần tạo, ở đây là Job.</li>
<li><strong>metadata</strong>: Danh sách các nhãn, các thuộc tính tùy ý mà người phát triển có thể gắn cho Job. Thường các thông tin về Metadata của ML model được gắn ở đây. Kubernetes cũng khuyến nghị một số nhãn ở <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/">đây</a>.</li>
<li><strong>spec.template</strong>: Chính là phần cấu hình của Pod mà ta cần khai báo, tương tự như cấu hình của Pod mà ta đã tạo ở bài trước.
<ul>
<li><strong>imagePullPolicy</strong>: Cho phép Kubernetes luôn luôn sử dụng Docker Image từ Docker Hub thay vì Cache Image.</li>
<li><strong>env</strong>: Danh sách các biến môi trường để Pod sử dụng. Ở đây, chúng ta khai bào 2 biến liên quan đến AWS để làm việc với AWS S3. Mình đã xóa các key mà mình sử dụng. Nếu bạn muốn chạy thử thì hãy thêm key của bạn vào nhé!</li>
</ul>
</li>
<li><strong>restartPolicy</strong>: Có khởi động lại Container khi nó bị chết hay không?</li>
<li><strong>backoffLimit</strong>: Số lần cố gắng thực hiện lại Job khi nó bị thất bị.</li>
</ul>
<p>Chạy lệnh sau để tạo và kiểm tra trạng thái của Job:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl create <span style="color:#f92672">-</span>f job<span style="color:#f92672">-</span>train<span style="color:#f92672">.</span>yaml
job<span style="color:#f92672">.</span>batch<span style="color:#f92672">/</span>job<span style="color:#f92672">-</span>train<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model created

<span style="color:#960050;background-color:#1e0010">$</span> kubectl get jobs
NAME                 COMPLETIONS   DURATION   AGE
job<span style="color:#f92672">-</span>train<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model   <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>           <span style="color:#ae81ff">58</span>s        <span style="color:#ae81ff">2</span>m19s
</code></pre></div><p>Kiểm tra xem các pods của Job là gì và trạng thái của chúng:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl get pods <span style="color:#f92672">--</span>selector<span style="color:#f92672">=</span>job<span style="color:#f92672">-</span>name<span style="color:#f92672">=</span>job<span style="color:#f92672">-</span>train<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model
NAME                       READY   STATUS      RESTARTS   AGE
job<span style="color:#f92672">-</span>train<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>fkcd   <span style="color:#ae81ff">0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     Completed   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">2</span>m19s
</code></pre></div><p>Xem logs Job/Pod:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl logs job<span style="color:#f92672">-</span>train<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>fkcd
Loading data<span style="color:#f92672">...</span>
Splitting data<span style="color:#f92672">...</span>
Fitting model<span style="color:#f92672">...</span>
Serializing model to: <span style="color:#f92672">/</span>docker<span style="color:#f92672">/</span>model<span style="color:#f92672">/</span>clf<span style="color:#f92672">.</span>joblib
Serializing metadata to: <span style="color:#f92672">/</span>docker<span style="color:#f92672">/</span>model<span style="color:#f92672">/</span>metadata<span style="color:#f92672">.</span>json
Moving to S3
</code></pre></div><p>Như vậy, có thể thấy là Job đã chạy xong, file model đã được lưu trên S3.</p>
<p>Cuối cùng, ta có thể xóa Job sau khi chúng đã hoàn thành nhiệm vụ của mình:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl delete job job<span style="color:#f92672">-</span>train<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model
job<span style="color:#f92672">.</span>batch <span style="color:#e6db74">&#34;job-train-ml-model&#34;</span> deleted
</code></pre></div><p><em><strong>2.4 Tạo Kubernetes Job để  thực hiện Batch Inference</strong></em></p>
<p>Chúng ta sẽ sử dụng lại Docker Image đã tạo ở trên cho Job này.</p>
<p>File cấu hình của Job (<em>job-inference.yaml</em>) như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">apiVersion: batch<span style="color:#f92672">/</span>v1
kind: Job
metadata:
  name: job<span style="color:#f92672">-</span>inference<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model
spec:
  template:
    spec:
      containers:
      <span style="color:#f92672">-</span> name: inference<span style="color:#f92672">-</span>container
        imagePullPolicy: Always
        image: tiensu<span style="color:#f92672">/</span>docker<span style="color:#f92672">-</span>ml:latest
        command: [<span style="color:#e6db74">&#34;python3&#34;</span>,  <span style="color:#e6db74">&#34;batch_inference.py&#34;</span>]
        env:
        <span style="color:#f92672">-</span> name: AWS_ACCESS_KEY_ID
          value: <span style="color:#e6db74">&#34;&#34;</span>
        <span style="color:#f92672">-</span> name: AWS_SECRET_ACCESS_KEY
          value: <span style="color:#e6db74">&#34;&#34;</span>
      restartPolicy: Never
  backoffLimit: <span style="color:#ae81ff">0</span>
</code></pre></div><p>So với cấu hình của Job phía trên, chỉ có các thông tin sau thay đổi: Job name, container name, container command.</p>
<p>Để tạo và liểm tra trạng thái của Job, chạy lệnh sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl create <span style="color:#f92672">-</span>f job<span style="color:#f92672">-</span>inference<span style="color:#f92672">.</span>yaml
job<span style="color:#f92672">.</span>batch<span style="color:#f92672">/</span>job<span style="color:#f92672">-</span>inference<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model created

<span style="color:#960050;background-color:#1e0010">$</span> kubectl get jobs
NAME                     COMPLETIONS   DURATION   AGE
job<span style="color:#f92672">-</span>inference<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model   <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>           <span style="color:#ae81ff">13</span>s        <span style="color:#ae81ff">66</span>s
</code></pre></div><p>Kiểm tra xem các Pods của Job và trạng thái tương ứng:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl get pods <span style="color:#f92672">--</span>selector<span style="color:#f92672">=</span>job<span style="color:#f92672">-</span>name<span style="color:#f92672">=</span>job<span style="color:#f92672">-</span>inference<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model
NAME                           READY   STATUS      RESTARTS   AGE
job<span style="color:#f92672">-</span>inference<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>sk2m4   <span style="color:#ae81ff">0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     Completed   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">2</span>m11s
</code></pre></div><p><em>Chú ý: Tên của Pod = Tên của Job + chuỗi ngẫu nhiên.</em></p>
<p>Xem logs của Job/Pod:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl logs job<span style="color:#f92672">-</span>inference<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>sk2m4
Running inference<span style="color:#f92672">...</span>
Loading data<span style="color:#f92672">...</span>
Loading model from: <span style="color:#f92672">/</span>docker<span style="color:#f92672">/</span>model<span style="color:#f92672">/</span>clf<span style="color:#f92672">.</span>joblib
Scoring observations<span style="color:#f92672">...</span>
[<span style="color:#ae81ff">15.32448686</span> <span style="color:#ae81ff">27.68741572</span> <span style="color:#ae81ff">24.21374322</span> <span style="color:#ae81ff">31.94786177</span> <span style="color:#ae81ff">10.40175849</span> <span style="color:#ae81ff">34.31050209</span>
 <span style="color:#ae81ff">22.05210667</span> <span style="color:#ae81ff">11.58265489</span> <span style="color:#ae81ff">13.19650094</span> <span style="color:#ae81ff">42.84036647</span> <span style="color:#ae81ff">33.03218733</span> <span style="color:#ae81ff">15.77635169</span>
 <span style="color:#ae81ff">23.93521876</span> <span style="color:#ae81ff">19.85532224</span> <span style="color:#ae81ff">25.43466604</span> <span style="color:#ae81ff">20.55132127</span> <span style="color:#ae81ff">13.67707622</span> <span style="color:#ae81ff">47.44313586</span>
 <span style="color:#ae81ff">17.6460682</span>  <span style="color:#ae81ff">21.51806638</span> <span style="color:#ae81ff">22.57388848</span> <span style="color:#ae81ff">16.97645106</span> <span style="color:#ae81ff">16.25503893</span> <span style="color:#ae81ff">20.57862843</span>
 <span style="color:#ae81ff">14.57438158</span> <span style="color:#ae81ff">11.81385445</span> <span style="color:#ae81ff">24.78353556</span> <span style="color:#ae81ff">37.77877263</span> <span style="color:#ae81ff">30.23411048</span> <span style="color:#ae81ff">19.67713185</span>
 <span style="color:#ae81ff">23.19380271</span> <span style="color:#ae81ff">24.96712102</span> <span style="color:#ae81ff">18.65459129</span> <span style="color:#ae81ff">30.35476911</span>  <span style="color:#ae81ff">8.9560549</span>  <span style="color:#ae81ff">13.8130382</span>
 <span style="color:#ae81ff">14.18848318</span> <span style="color:#ae81ff">17.3840622</span>  <span style="color:#ae81ff">19.83840166</span> <span style="color:#ae81ff">24.09904134</span> <span style="color:#ae81ff">20.52649052</span> <span style="color:#ae81ff">15.32433651</span>
 <span style="color:#ae81ff">25.8157052</span>  <span style="color:#ae81ff">16.47533793</span> <span style="color:#ae81ff">19.2214524</span>  <span style="color:#ae81ff">19.86928427</span> <span style="color:#ae81ff">21.47113681</span> <span style="color:#ae81ff">21.56443118</span>
 <span style="color:#ae81ff">24.64517965</span> <span style="color:#ae81ff">22.43665872</span> <span style="color:#ae81ff">22.1020877</span> ]
</code></pre></div><p>Như vậy là Job đã thực hiện Batch Inference thành công bằng model nhận được từ S3.</p>
<p>Cuối cùng, xóa Job sau khi nó đã hoàn thành nhiệm vụ để tiết kiệm tài nguyên server:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl delete job job<span style="color:#f92672">-</span>inference<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model
job<span style="color:#f92672">.</span>batch <span style="color:#e6db74">&#34;job-inference-ml-model&#34;</span> deleted
</code></pre></div><p><strong>3. Kết luận</strong></p>
<p>Như vậy là mình đã cùng các bạn tìm hiểu và sử dụng Kubernetes Job để thực hiện các tác vụ của một bài toán AI. Có một lưu ý dành cho các bạn đó là trong trường hợp việc thực hiện tạo Job thất bại, hãy nhớ sử dụng lệnh <code>kubectl describe pod &lt;pod_name&gt;</code>, trong đó <em>pod_name</em> là tên Pod của Job để xem đầy đủ logs. Dựa vào logs này, các bạn có thể dễ dàng phát hiện ra nguyên nhân lỗi và cách khắc phục chúng.</p>
<p>bài viết tiếp theo, chúng ta sẽ tìm hiểu và thực hành với CronJob. Mời các bạn đón đọc!</p>
<p>Source code của bài này các bạn tham khảo tại <a href="https://github.com/tiensu/Model_Deployment/tree/master/kubernetes_job">đây</a>.</p>
<p><strong>4. Tham khảo</strong></p>
<ul>
<li><a href="https://mlinproduction.com/k8s-jods/">Mlinproduction</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/job/">Kubernetes Jobs</a></li>
</ul>

        </div>

        
        
      </div>
    </div>
  </div>
</section>



<footer>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 text-center mb-5">
        <a href="https://tiensu.github.io/"><img src="https://tiensu.github.io/images/logo3.jpg" alt="SuNT&#39;s Blog | AI in Practical" style="height: auto"></a>
      </div>
               
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Contact Me</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="tel:0869644890"><i
                class="ti-mobile mr-3 text-primary"></i>0869644890</a></li>
          
                     
          <li class="mb-3"><i class="ti-location-pin mr-3 text-primary"></i>Hanoi, Vietnam</li>
          
                     
          <li class="mb-3"><a class="text-dark" href="mailto:tiensunguyen2103@gmail.com"><i
                class="ti-email mr-3 text-primary"></i>tiensunguyen2103@gmail.com</a>
          
          </li>
        </ul>
      </div>
      
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Social Contacts</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://www.facebook.com/tiensunguyen2103">Facebook</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://www.linkedin.com/in/su-nguyen-tien-aws%C2%AE-5ba74ba6/">Linkedin</a></li>
          
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Categories</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><a class="text-dark"
              href="/categories/algorithm-optimization">Algorithm Optimization</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/autoencoder">Autoencoder</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/convolution-neural-network">Convolution Neural Network</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/data-driff">Data driff</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/data-science">Data Science</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/deep-learning">Deep Learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/docker">Docker</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/ebook">Ebook</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/ensemble-learning">Ensemble Learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/face-recognition">Face recognition</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/image-classification">Image classification</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/kubernetes">Kubernetes</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/machine-learning">Machine Learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/mlops">Mlops</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/neural-network">Neural Network</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/one-shot-learning">One shot learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/project-management">Project Management</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/scalability">Scalability</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/siamese-network">Siamese network</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/text-classification">Text Classification</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/xgboost">Xgboost</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Quick Links</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://tiensu.github.io/about">About</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://tiensu.github.io/blog">Post</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://tiensu.github.io/contact">Contact</a></li>
          
        </ul>
      </div>
      <div class="col-12 border-top py-4 text-center">
        | copyright © 2021 <a href="tiensu.github.io">SuNT</a>. All Rights Reserved |
      </div>
    </div>
  </div>
</footer>

<script>
  var indexURL = "https://tiensu.github.io/index.json"
</script>

<!-- JS Plugins -->

<script src="https://tiensu.github.io/plugins/jQuery/jquery.min.js"></script>

<script src="https://tiensu.github.io/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://tiensu.github.io/plugins/slick/slick.min.js"></script>

<script src="https://tiensu.github.io/plugins/venobox/venobox.min.js"></script>

<script src="https://tiensu.github.io/plugins/search/fuse.min.js"></script>

<script src="https://tiensu.github.io/plugins/search/mark.js"></script>

<script src="https://tiensu.github.io/plugins/search/search.js"></script>

<!-- Main Script -->

<script src="https://tiensu.github.io/js/script.min.js"></script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js"></script>
<div id="js-cookie-box" class="cookie-box cookie-box-hide">
	This site uses cookies. By continuing to use this website, you agree to their use. <span id="js-cookie-button" class="btn btn-sm btn-primary ml-2">I Accept</span>
</div>
<script>
	(function ($) {
		const cookieBox = document.getElementById('js-cookie-box');
		const cookieButton = document.getElementById('js-cookie-button');
		if (!Cookies.get('cookie-box')) {
			cookieBox.classList.remove('cookie-box-hide');
			cookieButton.onclick = function () {
				Cookies.set('cookie-box', true, {
					expires:  2 
				});
				cookieBox.classList.add('cookie-box-hide');
			};
		}
	})(jQuery);
</script>


<style>
.cookie-box {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  text-align: center;
  z-index: 9999;
  padding: 1rem 2rem;
  background: rgb(71, 71, 71);
  transition: all .75s cubic-bezier(.19, 1, .22, 1);
  color: #fdfdfd;
}

.cookie-box-hide {
  display: none;
}
</style>
</body>
</html>