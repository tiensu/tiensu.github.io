<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <title>SuNT&#39;s Blog | AI in Practical</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="This is meta description">
  <meta name="author" content="SuNT">
  <meta name="generator" content="Hugo 0.68.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/slick/slick.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/themify-icons/themify-icons.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/venobox/venobox.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/css/override.css">
  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://tiensu.github.io/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://tiensu.github.io/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://tiensu.github.io/images/favicon.png " type="image/x-icon">

  <!-- google analitycs -->
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'Your ID', 'auto');
    ga('send', 'pageview');
  </script>

</head><body>
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0">
      <a class="navbar-brand mobile-view" href="https://tiensu.github.io/"><img class="img-fluid"
          src="https://tiensu.github.io/images/logo3.jpg" alt="SuNT&#39;s Blog | AI in Practical"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu h3"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <div class="desktop-view">
          <ul class="navbar-nav mr-auto">
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.facebook.com/tiensunguyen2103"><i class="ti-facebook"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.linkedin.com/in/su-nguyen-tien-aws%C2%AE-5ba74ba6/"><i class="ti-linkedin"></i></a>
            </li>
            
          </ul>
        </div>

        <a class="navbar-brand mx-auto desktop-view" href="https://tiensu.github.io/"><img class="img-fluid"
            src="https://tiensu.github.io/images/logo3.jpg" alt="SuNT&#39;s Blog | AI in Practical"></a>

        <ul class="navbar-nav">
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://tiensu.github.io/about">About</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://tiensu.github.io/blog">Post</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://tiensu.github.io/contact">Contact</a>
          </li>
          
          
        </ul>

        
        <!-- search -->
        <div class="search pl-lg-4">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://tiensu.github.io//search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        

        
      </div>
    </nav>
  </div>
  <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
      document.querySelectorAll("mjx-container").forEach(function(x){
        x.parentElement.classList += 'has-jax'})
    });

</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</header>
<!-- /navigation -->

<section class="section-sm">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        
        <a href="/categories/model-deployment"
          class="text-primary">Model deployment</a>
        
        <h2>Đóng gói AI model sử dụng Docker</h2>
        <div class="mb-3 post-meta">
          <span>By SuNT</span>
          
          <span class="border-bottom border-primary px-2 mx-1"></span>
          <span>03 January 2021</span>
          
        </div>
        
        <img src="https://tiensu.github.io/images/featured-post/36_docker.png" class="img-fluid w-100 mb-4" alt="Đóng gói AI model sử dụng Docker">
        
        <div class="content mb-5">
          <p>Đã bao giờ bạn gặp tình huống:</p>
<p><strong>Tại sao code trên máy tính của tôi chạy mà mang sang máy tính của bạn lại không chạy?</strong></p>
<p>99% câu trả lời cho câu hỏi này là do sự khác biệt về môi trường giữa 2 máy tính, 1% còn lại là do các nguyên nhân khác như copy thiếu file, sai đường dẫn, sử dụng câu lệnh không đúng, &hellip;</p>
<p>Trong bài toán AI, tình trạng này lại càng phổ biến hơn, bởi vì một model AI yêu cầu cơ man nào là thư viện đi kèm, thư viện này liên kết, ràng buộc với thư viện kia. Không những thế, với tốc độ phát triển như vũ bão hiện nay của AI, các thư viện cũng liên tục cập nhật phiên bản mới, và có khi code sử dụng phiên bản cũ lại không chạy được trên phiên bản mới. Rồi thì thư viện A phiên bản 1.x lại chỉ tương thích với thư viện B phiên bản 1.x.x, nếu ta cứ nhắm mắt gõ <code>pip install abc</code> thì mặc định sẽ là phiên bản mới nhất. Rất rất nhiều vấn đề xung đột thư viện xảy ra trong phát triển một bài toán AI trên nhiều máy tính khác nhau hoặc nhiều người cùng làm việc.</p>
<p>Vấn đề đặt ra lúc này là phải làm sao <code>cô lập</code> được môi trường phát triển dành riêng cho 1 bài toán AI cụ thể. Môi trường đó phải tách biệt hoàn toàn với môi trường trên máy tính, và phải dễ dàng di chuyển giữa nhiều máy tính với nhau.</p>
<p>Một số công cụ đã ra đời để hỗ trợ giải quyết vấn đề này bằng cách tạo ra các môi trường ảo. Có thể kể đến như <a href="https://www.anaconda.com/">anaconda</a>, <a href="https://pypi.org/project/virtualenv/">venv`</a>, &hellip; Mỗi loại đều có những ưu nhược điểm riêng, và phụ thuộc vào thói quen sử dụng của mỗi người. Cá nhân mình cũng đã từng sử dụng qua các loại kể trên nhưng thấy chúng vẫn chưa thể giải quyết được triệt để vấn đề về xung đột môi trường &hellip;</p>
<p>Cho đến khi mình biết đến <a href="https://www.docker.com/">Docker</a>, một công cụ rất <code>powerfull</code>, rất tuyệt vời. Có thể nói docker đã giải quyết được tận gốc vấn đề làm đau đầu những nhà phát triể n AI bấy lâu nay.</p>
<p>Trong bài này, chúng ta sẽ cùng nhau tìm hiểu về docker và cách sử dụng nó trong viêc đóng gói một AI model.</p>
<p><strong>1. Docker là gì?</strong></p>
<p>Theo định nghĩa chính thức tại <a href="https://docs.docker.com/get-started/overview/">trang chủ</a> của docker thì:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Docker <span style="color:#f92672">is</span> an open platform <span style="color:#66d9ef">for</span> developing, shipping, <span style="color:#f92672">and</span> running applications<span style="color:#f92672">.</span>
</code></pre></div>

<div style="text-align:center">
    <img style="height:auto" src="/images/post/36_docker.png">
</div>


<p>Hiểu một cách đơn giản thì docker là một nền tảng mã nguồn mở cho việc phát triển, chạy và phân phối các ứng dụng. Nó cho phép chúng ta tách biệt ứng dụng ra khỏi kiến trúc hạ tầng chung của toàn hệ thống và dễ dang mang toàn bộ ứng dụng đó (<em>bao gồm cả môi trường thực thi</em>) sang một máy tính hoàn toàn mới. Điều này giúp các nhà phát triển ứng dụng giảm được thời gian đáng kể ở công đoạn đưa sản phẩm vào sử dụng trong thực tế.</p>
<p>Một số khái niệm cần biết khi làm việc với docker:</p>
<ul>
<li>Docker image: Là một file không thể thay đổi (<em>read-only</em>), chứa toàn bộ source code, thư viện, công cụ, &hellip; cần thiết để một ứng dụng có thể chạy được.</li>
<li>Docker container: Là một &ldquo;bản sao&rdquo;, hay một &ldquo;instance&rdquo; của docker image tại thời điểm khởi chạy docker image. Và thực tế là chúng ta chỉ làm việc trên các containers chứ không làm việc với các images. Sau khi kết thúc phiên làm việc thì container sẽ biến mất, và các thay đổi của container đó sẽ không được lưu lại vào docker image sinh ra container đó. Nếu bạn muốn lưu lại các thay đổi bạn đã thực hiện thì có thể sử dụng lệnh &ldquo;docker commit&rdquo;, nhưng nó sẽ tạo ra một docker image mới bao gồm docker image cũ và phần thay đổi. Đối với sự thay đổi trên các file, thư mục, ta có thể lưu lại sự thay đổi để sử dụng ở nơi khác mà không cần tạo docker image mới bằng cách đặt các file cần thay đổi ở thư mục chung, chia sẻ với máy tính bên ngoài (<em>host</em>).</li>
<li>Docker hub: Là một kho (<em>repository</em>) chứa các docker images, cho phép bạn chia sẻ các docker images của bạn cho người khác bằng cách upload nó lên docker hub. Khi người nào muốn sử dụng docker image của bạn, họ chỉ cần tải về để sử dụng.</li>
<li>Host: Là máy tính cài đặt docker và chạy các docker containers.</li>
</ul>
<p><strong>2. Cài đặt Docker</strong></p>
<p>Để sử dụng docker thì trước tiên cần phải cài đặt <code>docker engine</code>. Các cài đặt khá đơn giản, hãy làm theo hướng dẫn trên <a href="https://docs.docker.com/engine/install/ubuntu/">trang chủ của docker</a>.</p>
<p>Sau khi cài xong docker, hãy thử chạy lệnh sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">docker run tensorflow<span style="color:#f92672">/</span>tensorflow:<span style="color:#ae81ff">2.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span>gpu
</code></pre></div><p>Nếu thấy output như sau tức là ta đã cài đặt thành công:


<div style="text-align:center">
    <img style="height:auto" src="/images/post/36_docker_2.png">
</div>

</p>
<p>Ở đây, tensorflow/tensorflow:2.3.0-gpu là docker image trên docker hub, được cài đặt sẵn tensorflow 2.3.0 và cuda.</p>
<p>Kiểm tra image vừa tải về trong danh sách:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">docker images
</code></pre></div><p>Kết quả:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">REPOSITORY              TAG         IMAGE ID       CREATED       SIZE
tensorflow<span style="color:#f92672">/</span>tensorflow   <span style="color:#ae81ff">2.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span>gpu   <span style="color:#ae81ff">3</span>b8d4cbd6723   <span style="color:#ae81ff">3</span> weeks ago   <span style="color:#ae81ff">3.18</span>GB
</code></pre></div><p>Nếu bạn muốn sử dụng GPU (<em>giả sử là NVIDIA</em>) trong docker thì bạn cần thêm 2 điều kiện:</p>
<ul>
<li>Máy tính của bạn phải có GPU và đã cài đặt đầy đủ driver, cuda, cudnn (<em>có thể sử dụng GPU bình thường trong các task DL mà không sử dụng docker</em>).</li>
<li>Cài thêm <code>NVIDIA Container Tookit</code> theo hướng dẫn ở <a href="https://github.com/NVIDIA/nvidia-docker">đây</a></li>
</ul>
<p>Như trên máy tính của mình đã có đủ 2 điều kiện trên, mình kiểm tra GPU bên trong docker như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">docker run <span style="color:#f92672">--</span>gpus all <span style="color:#f92672">--</span>rm tensorflow<span style="color:#f92672">/</span>tensorflow:<span style="color:#ae81ff">2.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span>gpu nvidia<span style="color:#f92672">-</span>smi
</code></pre></div><p>Kết quả:


<div style="text-align:center">
    <img style="height:auto" src="/images/post/36_docker_3.png">
</div>

</p>
<p>Hoặc chi tiết hơn:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">docker run <span style="color:#f92672">--</span>gpus all <span style="color:#f92672">--</span>rm tensorflow<span style="color:#f92672">/</span>tensorflow:<span style="color:#ae81ff">2.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span>gpu python <span style="color:#f92672">-</span>c <span style="color:#e6db74">&#34;import tensorflow as tf; print(tf.reduce_sum(tf.random.normal([1000, 1000])))&#34;</span>
</code></pre></div><p>Kết quả:


<div style="text-align:center">
    <img style="height:auto" src="/images/post/36_docker_4.png">
</div>

</p>
<p>Trong đó:</p>
<ul>
<li>&ndash;gpus all: Cho phép sử dụng GPU trong docker.</li>
<li>&ndash;rm: Xóa docker container sau khi chạy lệnh xong.</li>
</ul>
<p>Để cho phép mặc định sử dụng GPU trong docker (<em>không cần sử dụng &ndash;gpus all</em>), bạn có thể làm như sau:</p>
<ul>
<li>Thêm <code>default-runtime&quot;: &quot;nvidia&quot;</code> vào trong file <code>/etc/docker/daemon.json</code></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># filename: /etc/docker/daemon.json</span>
{
    <span style="color:#e6db74">&#34;default-runtime&#34;</span>: <span style="color:#e6db74">&#34;nvidia&#34;</span>,
    <span style="color:#e6db74">&#34;runtimes&#34;</span>: {
        <span style="color:#e6db74">&#34;nvidia&#34;</span>: {
            <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;nvidia-container-runtime&#34;</span>,
            <span style="color:#e6db74">&#34;runtimeArgs&#34;</span>: []
        }
    }
}
</code></pre></div><ul>
<li>Khởi động lại docker:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">sudo pkill <span style="color:#f92672">-</span>SIGHUP dockerd
</code></pre></div><p>Mình đã tổng hợp lại các lệnh hay sử dụng của docker ở phần phụ lục. Các bạn có thể tham khảo thêm.</p>
<p><strong>3. Xây dựng uWSGI docker image</strong></p>
<p>Bên cạnh những images được xây dựng sẵn và chia sẻ trên docker hub, docker cũng hỗ trợ bạn tự build các images cho riêng bạn, phù hợp với từng nhu cầu của bạn. Tất cả được thực hiện thông qua 1 file cấu hình, gọi là <code>Dockerfile</code>.</p>
<p>Trong phần này, ta sẽ cùng nhau xây dựng một DL docker image, bao gồm toàn bộ source code ở <a href="https://tiensu.github.io/blog/35_deploy_dl_model_as_webapp_with_uwsgi/">bài trước</a>. Ta cũng cấu hình Flask, uWSGI trong docker image để chạy được source code đó.</p>


<div style="text-align:center">
    <img style="height:auto" src="/images/post/36_docker_5.png">
</div>


<p><em><strong>3.1 Bước 1</strong></em></p>
<p>Tạo một thư mục tên là <code>uwsgi</code>, và copy toàn bộ source code của bài trước (<em>bao gồm cả model, bỏ đi file client.py vì ta sẽ chạy client ở bên ngoài docker</em>) vào thư mục vừa tạo.</p>
<p><em><strong>3.2 Bước 2</strong></em></p>
<p>Tạo file <code>requirements.txt</code> chứa toàn bộ thư viện cần dùng để chạy code (<em>cũng đặt trong thư mục uWSGI</em>). Bạn có thể sinh ra file này tự động bằng lệnh <code>pip freeze &gt; requirements.txt</code>. Tuy nhiên, nếu làm theo cách này thì file <code>requirements.txt</code> sẽ chứa rất nhiều thư viện không cần thiết, bởi vì hầu hết chúng phụ thuộc vào các thư viện khác. Nếu bạn theo dõi từ đầu, bạn chắc chắc biết rằng, ta sẽ chỉ cần những những thư viện sau là đủ: tensorflow, uwsgi, flask, opencv. Trong đó, vì mình dự định không build docker image từ đầu mà kế thừa từ 1 image đã build sẵn (<em>cụ thể là tensorflow/tensorflow:2.3.0-gpu đã tải về ở phần trước</em>) nên tensorflow đã được tích hợp sẵn, không cần cài lại nữa. Cuối cùng, file <code>requirements.txt</code> của chúng ta chỉ như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Flask<span style="color:#f92672">==</span><span style="color:#ae81ff">1.1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2</span>
uWSGI<span style="color:#f92672">==</span><span style="color:#ae81ff">2.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">18</span>
opencv<span style="color:#f92672">-</span>python<span style="color:#f92672">==</span><span style="color:#ae81ff">4.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.46</span>
</code></pre></div><p><strong>3.3 Bước 3</strong></p>
<p>Tạo file cấu hình cho uWSGI. Vì mình muốn kiểm tra riêng sự hoạt động của uWSGI nên file cấu hình sẽ như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">[uwsgi] 
  
http <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.0</span>:<span style="color:#ae81ff">8080</span>
wsgi<span style="color:#f92672">-</span>file <span style="color:#f92672">=</span> server<span style="color:#f92672">.</span>py
callable <span style="color:#f92672">=</span> app
die<span style="color:#f92672">-</span>on<span style="color:#f92672">-</span>term <span style="color:#f92672">=</span> true
processes <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>
threads <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
chdir <span style="color:#f92672">=</span> <span style="color:#f92672">/</span>uwsgi
master <span style="color:#f92672">=</span> false 
vacuum <span style="color:#f92672">=</span> truemodule
</code></pre></div><p>Trong phần sau, chúng ta sẽ kết hợp thêm Nginx. Khi đó sẽ cần thay đổi lại cấu hình của uWSGI lại một chút.</p>
<p><em><strong>3.3 Bước 4</strong></em></p>
<p>Tạo <code>Dockerfile</code> (<em>trong thư mục uwsgi</em>) chứa các thông tin cấu hình cần thiết để tạo docker image. Nội dung của file này như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">FROM tensorflow<span style="color:#f92672">/</span>tensorflow:<span style="color:#ae81ff">2.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span>gpu <span style="color:#75715e"># kế thừa từ image tensorflow/tensorflow:2.3.0-gpu</span>
WORKDIR <span style="color:#f92672">/</span>uwsgi <span style="color:#75715e"># thư mục làm viêc mặc định bên trong docker</span>
ADD <span style="color:#f92672">.</span> <span style="color:#f92672">/</span>uwsgi <span style="color:#75715e"># local folder để copy vào thư mục làm việc của docker, chính là thư mục chúng ta tạo ở bước 1</span>
RUN pip install <span style="color:#f92672">-</span>r requirements<span style="color:#f92672">.</span>txt <span style="color:#75715e"># cài đặt các thư viện cần thiết trong file requirements.txt</span>
RUN apt<span style="color:#f92672">-</span>get update 
RUN apt<span style="color:#f92672">-</span>get install ffmpeg libsm6 libxext6  <span style="color:#f92672">-</span>y <span style="color:#75715e"># sửa lỗi opencv, thử bỏ đi để xem điều gì xảy ra?</span>
CMD [<span style="color:#e6db74">&#34;uwsgi&#34;</span>, <span style="color:#e6db74">&#34;app.ini&#34;</span>] <span style="color:#75715e"># chạy lệnh &#34;uwsgi app.ini&#34; khi khởi chạy docker image</span>
</code></pre></div><p>Có rất rất nhiều tùy chọn khi viết Dockerfile, tham khảo ở <a href="https://docs.docker.com/engine/reference/builder/">đây</a> nếu bạn cần thêm thông tin.</p>
<p>Thự mục <code>uwsgi</code> lúc này sẽ như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">├──</span> animal_model_classification<span style="color:#f92672">.</span>h5
<span style="color:#960050;background-color:#1e0010">├──</span> app<span style="color:#f92672">.</span>ini
<span style="color:#960050;background-color:#1e0010">├──</span> cat<span style="color:#f92672">.</span><span style="color:#ae81ff">1.j</span>pg
<span style="color:#960050;background-color:#1e0010">├──</span> Dockerfile
<span style="color:#960050;background-color:#1e0010">├──</span> dog<span style="color:#f92672">.</span><span style="color:#ae81ff">1.j</span>pg
<span style="color:#960050;background-color:#1e0010">├──</span> requirements<span style="color:#f92672">.</span>txt
<span style="color:#960050;background-color:#1e0010">└──</span> server<span style="color:#f92672">.</span>py
</code></pre></div><p>Trong đó, 2 files ảnh là để chúng ta thực hiện việc test về sau.</p>
<p><strong>4 Build docker image</strong></p>
<p>OK, mọi thứ cần thiết đã chuẩn bị xong, ta sẽ chạy lệnh sau để buidl docker image:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">docker build <span style="color:#f92672">-</span>t image<span style="color:#f92672">-</span>classification<span style="color:#f92672">-</span>production:<span style="color:#ae81ff">1.0</span> <span style="color:#f92672">.</span>
</code></pre></div><p>Docker image được sinh ra sẽ có tên là <code>image-classification-production</code>, kèm theo tag <code>1.0</code> để phân biệt nó với các phiên bản khác trong tương lai.</p>
<p>Nếu build, thành công, output sẽ như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"> <span style="color:#f92672">---&gt;</span> a2a60f32471b
Step <span style="color:#ae81ff">7</span><span style="color:#f92672">/</span><span style="color:#ae81ff">7</span> : CMD [<span style="color:#e6db74">&#34;uwsgi&#34;</span>, <span style="color:#e6db74">&#34;app.ini&#34;</span>]
 <span style="color:#f92672">---&gt;</span> Running <span style="color:#f92672">in</span> <span style="color:#ae81ff">3776</span>d496ca68
Removing intermediate container <span style="color:#ae81ff">3776</span>d496ca68
 <span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">53150</span>d1373a3
Successfully built <span style="color:#ae81ff">53150</span>d1373a3
Successfully tagged image<span style="color:#f92672">-</span>classification<span style="color:#f92672">-</span>production:<span style="color:#ae81ff">1.0</span>
</code></pre></div><p>Kiểm tra docker image trong danh sách:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">docker images
</code></pre></div><p>Kết quả:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">REPOSITORY                        TAG         IMAGE ID       CREATED              SIZE
image<span style="color:#f92672">-</span>classification<span style="color:#f92672">-</span>production   <span style="color:#ae81ff">1.0</span>         <span style="color:#ae81ff">53150</span>d1373a3   About a minute ago   <span style="color:#ae81ff">5.37</span>GB
tensorflow<span style="color:#f92672">/</span>tensorflow             <span style="color:#ae81ff">2.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span>gpu   <span style="color:#ae81ff">3</span>b8d4cbd6723   <span style="color:#ae81ff">3</span> weeks ago          <span style="color:#ae81ff">3.18</span>GB
</code></pre></div><p><strong>5 Chạy docker image</strong></p>
<p>Để chạy docker image vừa tạo, ta sử dụng lệnh sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">docker run <span style="color:#f92672">--</span>rm <span style="color:#f92672">--</span>publish <span style="color:#ae81ff">80</span>:<span style="color:#ae81ff">8080</span>  <span style="color:#f92672">--</span>name dlp  image<span style="color:#f92672">-</span>classification<span style="color:#f92672">-</span>production:<span style="color:#ae81ff">1.0</span>
</code></pre></div><p>Có 2 cái mà ta phải chú ý ở đây:</p>
<ul>
<li>Tham số <code>--public 80:8080</code> sẽ &ldquo;expose&rdquo; port 8080 của container tới port 80 của host. Nói cách khác, tất cả các requests đến địa chỉ localhost:80 sẽ được chuyển tiếp đến địa chỉ 0.0.0.0:8080 bên trong container. 8080 được gọi là <code>listening port</code> của uWSGI.</li>
<li>Tham số <code>--name dlp</code> sẽ đặt tên cho container là <code>dlp</code>. Ta nên đặt tên cho container để dễ làm việc với nó hơn. Ngược lại, docker sẽ tạo cho nó một ID ngẫu nhiên.</li>
</ul>
<p>Kết quả:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">52</span>:<span style="color:#ae81ff">45.347188</span>: I tensorflow<span style="color:#f92672">/</span>stream_executor<span style="color:#f92672">/</span>cuda<span style="color:#f92672">/</span>cuda_gpu_executor<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">982</span>] successful NUMA node read <span style="color:#f92672">from</span> SysFS had negative value (<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), but there must be at least one NUMA node, so returning NUMA node zero
<span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">52</span>:<span style="color:#ae81ff">45.347580</span>: I tensorflow<span style="color:#f92672">/</span>stream_executor<span style="color:#f92672">/</span>cuda<span style="color:#f92672">/</span>cuda_gpu_executor<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">982</span>] successful NUMA node read <span style="color:#f92672">from</span> SysFS had negative value (<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), but there must be at least one NUMA node, so returning NUMA node zero
<span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">52</span>:<span style="color:#ae81ff">45.347925</span>: I tensorflow<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>common_runtime<span style="color:#f92672">/</span>gpu<span style="color:#f92672">/</span>gpu_device<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">1402</span>] Created TensorFlow device (<span style="color:#f92672">/</span>job:localhost<span style="color:#f92672">/</span>replica:<span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>task:<span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>device:GPU:<span style="color:#ae81ff">0</span> <span style="color:#66d9ef">with</span> <span style="color:#ae81ff">4676</span> MB memory) <span style="color:#f92672">-&gt;</span> physical GPU (device: <span style="color:#ae81ff">0</span>, name: GeForce GTX <span style="color:#ae81ff">1660</span> Ti <span style="color:#66d9ef">with</span> Max<span style="color:#f92672">-</span>Q Design, pci bus id: <span style="color:#ae81ff">0000</span>:<span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">00.0</span>, compute capability: <span style="color:#ae81ff">7.5</span>)
<span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">52</span>:<span style="color:#ae81ff">47.271932</span>: W tensorflow<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>framework<span style="color:#f92672">/</span>cpu_allocator_impl<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">81</span>] Allocation of <span style="color:#ae81ff">536870912</span> exceeds <span style="color:#ae81ff">10</span><span style="color:#f92672">%</span> of free system memory<span style="color:#f92672">.</span>
<span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">52</span>:<span style="color:#ae81ff">47.621364</span>: W tensorflow<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>framework<span style="color:#f92672">/</span>cpu_allocator_impl<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">81</span>] Allocation of <span style="color:#ae81ff">536870912</span> exceeds <span style="color:#ae81ff">10</span><span style="color:#f92672">%</span> of free system memory<span style="color:#f92672">.</span>
<span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">52</span>:<span style="color:#ae81ff">47.918398</span>: W tensorflow<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>framework<span style="color:#f92672">/</span>cpu_allocator_impl<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">81</span>] Allocation of <span style="color:#ae81ff">536870912</span> exceeds <span style="color:#ae81ff">10</span><span style="color:#f92672">%</span> of free system memory<span style="color:#f92672">.</span>
<span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">52</span>:<span style="color:#ae81ff">48.759371</span>: W tensorflow<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>framework<span style="color:#f92672">/</span>cpu_allocator_impl<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">81</span>] Allocation of <span style="color:#ae81ff">536870912</span> exceeds <span style="color:#ae81ff">10</span><span style="color:#f92672">%</span> of free system memory<span style="color:#f92672">.</span>
<span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">52</span>:<span style="color:#ae81ff">49.637126</span>: W tensorflow<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>framework<span style="color:#f92672">/</span>cpu_allocator_impl<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">81</span>] Allocation of <span style="color:#ae81ff">536870912</span> exceeds <span style="color:#ae81ff">10</span><span style="color:#f92672">%</span> of free system memory<span style="color:#f92672">.</span>
WSGI app <span style="color:#ae81ff">0</span> (mountpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>) ready <span style="color:#f92672">in</span> <span style="color:#ae81ff">8</span> seconds on interpreter <span style="color:#ae81ff">0x55cf948bc720</span> pid: <span style="color:#ae81ff">1</span> (default app)
uWSGI running <span style="color:#66d9ef">as</span> root, you can use <span style="color:#f92672">--</span>uid<span style="color:#f92672">/--</span>gid<span style="color:#f92672">/--</span>chroot options
<span style="color:#f92672">***</span> WARNING: you are running uWSGI <span style="color:#66d9ef">as</span> root <span style="color:#960050;background-color:#1e0010">!!!</span> (use the <span style="color:#f92672">--</span>uid flag) <span style="color:#f92672">***</span> 
<span style="color:#f92672">***</span> uWSGI <span style="color:#f92672">is</span> running <span style="color:#f92672">in</span> multiple interpreter mode <span style="color:#f92672">***</span>
spawned uWSGI worker <span style="color:#ae81ff">1</span> (<span style="color:#f92672">and</span> the only) (pid: <span style="color:#ae81ff">1</span>, cores: <span style="color:#ae81ff">1</span>)
</code></pre></div><p>Ta quan sá thấy container đã chạy thành công và uWSGI cũng đã được khởi động.</p>
<p><em>Lưu ý: Trong trường hợp port 80 đã được sử dụng bới ứng dụng khác (nginx trong bài trước chẳng hạn), bạn phải close ứng dụng đó hoặc sử dụng một port khác.</em></p>
<p>Để kiểm tra xem uWSGI có làm viêc đúng hay không, ta có thể sử dụng lại client đã chuẩn bị từ bài trước (<em>nhớ đổi port của ENDPOINT_URL từ 8080 thành 80</em>).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">python client<span style="color:#f92672">.</span>py
</code></pre></div><p>Kết quả:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cat&#39;</span>
</code></pre></div><p>Như vậy là uWSGI đã được cài đặt thành công vào docker.</p>


<div style="text-align:center">
    <img style="height:auto" src="/images/post/36_docker_6.png">
</div>


<p><em>Lưu ý: Trong quá trình viết bài này, mình gặp lỗi liên quan đến cuda khi chạy test uWSGI. Mình xóa hết các docker images đi và chạy lại từ đầu thì không bị lỗi nữa.</em></p>
<p><strong>6. Xây dựng Nginx docker image</strong></p>
<p>Tương tự như việc xây dựng uWSGI docker image, chúng ta sẽ đi build một Nginx docker image, đặt trước uWSGI server thực hiện vai trò như một <code>reverse proxy</code>.</p>
<p><em><strong>6.1 Bước 1</strong></em></p>
<p>Tạo thư mục <code>nginx</code>, cùng cấp với thư mục <code>uwsgi</code>.</p>
<p><em><strong>6.2 Bước 2</strong></em></p>
<p>Tạo file cấu hình Nginx, tên là <code>nginx.conf</code>, đặt trong thư mục <code>nginx</code>, với nội dung như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">server {
  listen <span style="color:#ae81ff">80</span>;

  location <span style="color:#f92672">/</span> {
    include uwsgi_params;
    uwsgi_pass  uwsgi:<span style="color:#ae81ff">660</span> ;
  }
</code></pre></div><p>Với cấu hình này thì Nginx sẽ lắng nghe trên port 80, chuyển tiếp các requests đến port 660 của uWSGI server thông qua socket (<em>sử dụng giao thức uwsgi</em>).</p>
<p><em><strong>6.3 Bước 3</strong></em></p>
<p>Cập nhật lại cấu hình của uWSGI (<em>file app.ini</em>) để làm việc được với Nginx, như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">module <span style="color:#f92672">=</span> server
socket<span style="color:#f92672">=</span> :<span style="color:#ae81ff">660</span>
callable <span style="color:#f92672">=</span> app
die<span style="color:#f92672">-</span>on<span style="color:#f92672">-</span>term <span style="color:#f92672">=</span> true
processes <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
master <span style="color:#f92672">=</span> false
vacuum <span style="color:#f92672">=</span> true
</code></pre></div><p><em><strong>6.4 Bước 4</strong></em></p>
<p>Tạo file Dockerfile cho Nginix docker trong thư mục <code>nginx</code>. Nginix docker image được kế thừa từ nginx image trên docker hub, ta chỉ việc thay thế cấu hình mặc định của nó bằng cấu hình mà ta vừa tạo ở bước 3.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">FROM nginx

RUN rm <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>nginx<span style="color:#f92672">/</span>conf<span style="color:#f92672">.</span>d<span style="color:#f92672">/</span>default<span style="color:#f92672">.</span>conf
COPY nginx<span style="color:#f92672">.</span>conf <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>nginx<span style="color:#f92672">/</span>conf<span style="color:#f92672">.</span>d<span style="color:#f92672">/</span>
</code></pre></div><p>Đến đây, nếu chạy lệnh <code>docker build ...</code> thì ta sẽ có được nginx docker image. Nhưng nếu chỉ chạy một mình image này thì không có tác dụng gì cả. Ta cần phải kết hợp cả 2 docker images uwsgi và nginx. Đó chính là công viêc của <code>docker-compose</code>.</p>
<p><strong>7. Chạy đồng thời nhiều docker containers với Docker Compose</strong></p>
<p>Liệu bạn có thắc mắc rằng tại sao ta không build cả Nginx và uWSGI vào chung 1 docker image? Chẳng phải như thế sẽ tiện hơn hay sao?</p>
<p>Câu trả lời là không nên làm vậy. Theo kiến trúc làm việc kết hợp giữa Nginx và uWSGI thì một Nginx instance có thể kết hợp với nhiề u uWSGI instances. Nếu ta kết hợp chung lại, sẽ không tận dụng được khả năng này. Thêm nữa, dung lượng của docker image sẽ rất lớn nếu ta kết hợp lại.</p>


<div style="text-align:center">
    <img style="height:auto" src="/images/post/36_docker_7.png">
</div>


<p>Mở rộng ra, nếu một hệ thống của chúng ta bao gồm cả database, backend, front-end, messaging systems, task queue, &hellip; ta không thể chạy tất tần tật mọi thứ trong một docker container được.</p>
<p>Từ góc độ của nhà phát triển phần mềm, docker-compose chỉ là một file cấu hình, định nghĩa tất cả containers và cách thức mà các containers đó tương tác với nhau.</p>
<p><em><strong>7.1 Cài đặt docker-compose</strong></em></p>
<p>Để cài đặt docker-compose. Bạn hãy làm theo hướng dẫn sau trên <a href="https://docs.docker.com/compose/install/">trang chủ</a> của  docker.</p>
<p><em><strong>7.2 Định nghĩa cấu hình của docker-compose</strong></em></p>
<p>Tạo file <code>docker-compose.yml</code> (<em>bên ngoài 2 thư mục uwsgi và nginx</em>), với nội dung như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">version : <span style="color:#e6db74">&#34;3.7&#34;</span>

services:
  uwsgi:
    build: <span style="color:#f92672">./</span>uwsgi
    container_name: uwsgi_img_classification
    restart: always
    expose:
      <span style="color:#f92672">-</span> <span style="color:#ae81ff">660</span>

  nginx:
    build: <span style="color:#f92672">./</span>nginx
    container_name: nginx
    restart: always
    ports:
      <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;80:80&#34;</span>
</code></pre></div><p>Phần chính của cấu hình này là khai báo 2 containers, gọi là 2 services. Hai tham số quan trọng của mỗi services là:</p>
<ul>
<li><em>build</em>: thư mục chứa Dockerfile và các files cần thiết của mỗi container.</li>
<li><em>restart</em>: tự động khởi động lại service nếu xay ra lỗi.</li>
<li><em>expose</em>: uwsgi lắng nghe request đến trên port 660 (chỉ trong phạm vi docker).</li>
<li><em>port</em>: nginx mở port 80 ra bên ngoài (<em>có thể chọn tùy ý</em>) để lắng nghe requests đến, ánh xạ đến port 80 (<em>theo như cấu hình trong file nginx.conf</em>) của container.</li>
</ul>
<p>Như vậy, có thể tóm tắt lại flow như sau:</p>
<ul>
<li>Các requests từ clients đến port 80 của host.</li>
<li>Các requests được ánh xạ sang port 80 của nginx container.</li>
<li>Các requests tiếp tục được chuyển tiếp đến port 660 của uwsgi container.</li>
<li>uwsgi gọi Flask endpoint và thực hiện quá trình nhận diện.</li>
<li>uwsgi gửi lại kết quả nhận diện theo hướng ngược lại.</li>
</ul>
<p><em><strong>7.3 Build docker-compose</strong></em></p>
<p>Chạy lệnh sau để build docker-compose với cả 2 containers.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">docker<span style="color:#f92672">-</span>compose build
</code></pre></div><p>Nếu build thành công, output sẽ như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Step <span style="color:#ae81ff">7</span><span style="color:#f92672">/</span><span style="color:#ae81ff">7</span> : CMD [<span style="color:#e6db74">&#34;uwsgi&#34;</span>, <span style="color:#e6db74">&#34;app.ini&#34;</span>]
 <span style="color:#f92672">---&gt;</span> Running <span style="color:#f92672">in</span> <span style="color:#ae81ff">9608e1187</span>e82
Removing intermediate container <span style="color:#ae81ff">9608e1187</span>e82
 <span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">357</span>fe8e41768

Successfully built <span style="color:#ae81ff">357</span>fe8e41768
Successfully tagged docker_uwsgi:latest
Building nginx
Step <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">3</span> : FROM nginx
latest: Pulling <span style="color:#f92672">from</span> library<span style="color:#f92672">/</span>nginx
<span style="color:#ae81ff">6</span>ec7b7d162b2: Pull complete
cb420a90068e: Pull complete
<span style="color:#ae81ff">2766</span>c0bf2b07: Pull complete
e05167b6a99d: Pull complete
<span style="color:#ae81ff">70</span>ac9d795e79: Pull complete
Digest: sha256:<span style="color:#ae81ff">4</span>cf620a5c81390ee209398ecc18e5fb9dd0f5155cd82adcbae532fec94006fb9
Status: Downloaded newer image <span style="color:#66d9ef">for</span> nginx:latest
 <span style="color:#f92672">---&gt;</span> ae2feff98a0c
Step <span style="color:#ae81ff">2</span><span style="color:#f92672">/</span><span style="color:#ae81ff">3</span> : RUN rm <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>nginx<span style="color:#f92672">/</span>conf<span style="color:#f92672">.</span>d<span style="color:#f92672">/</span>default<span style="color:#f92672">.</span>conf
 <span style="color:#f92672">---&gt;</span> Running <span style="color:#f92672">in</span> <span style="color:#ae81ff">11140e051282</span>
Removing intermediate container <span style="color:#ae81ff">11140e051282</span>
 <span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">1</span>fcc92cfdfc4
Step <span style="color:#ae81ff">3</span><span style="color:#f92672">/</span><span style="color:#ae81ff">3</span> : COPY nginx<span style="color:#f92672">.</span>conf <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>nginx<span style="color:#f92672">/</span>conf<span style="color:#f92672">.</span>d<span style="color:#f92672">/</span>
 <span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">21</span>bda0089cca

Successfully built <span style="color:#ae81ff">21</span>bda0089cca
Successfully tagged docker_nginx:latest
</code></pre></div><p>Kiểm tra thử danh sách images bằng lệnh <code>docker images</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">REPOSITORY                        TAG         IMAGE ID       CREATED         SIZE
docker_nginx                      latest      <span style="color:#ae81ff">21</span>bda0089cca   <span style="color:#ae81ff">4</span> minutes ago   <span style="color:#ae81ff">133</span>MB
docker_uwsgi                      latest      <span style="color:#ae81ff">357</span>fe8e41768   <span style="color:#ae81ff">5</span> minutes ago   <span style="color:#ae81ff">5.37</span>GB
image<span style="color:#f92672">-</span>classification<span style="color:#f92672">-</span>production   <span style="color:#ae81ff">1.0</span>         bd9928abee21   <span style="color:#ae81ff">2</span> hours ago     <span style="color:#ae81ff">5.37</span>GB
nginx                             latest      ae2feff98a0c   <span style="color:#ae81ff">3</span> weeks ago     <span style="color:#ae81ff">133</span>MB
tensorflow<span style="color:#f92672">/</span>tensorflow             <span style="color:#ae81ff">2.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span>gpu   <span style="color:#ae81ff">3</span>b8d4cbd6723   <span style="color:#ae81ff">3</span> weeks ago     <span style="color:#ae81ff">3.18</span>GB
</code></pre></div><p>Ta thấy hai containers <code>docker_nginx</code> và <code>docker_uwsgi</code> đã xuất hiện.</p>
<p><em><strong>7.4 Kiểm tra hoạt động của hệ thống</strong></em></p>
<p>Ta sẽ khởi động các containers lên để kiểm tra thử xem hê thống có làm việc chính xác không.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">docker<span style="color:#f92672">-</span>compose up
</code></pre></div><p>Khởi động thành công:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Starting nginx                    <span style="color:#f92672">...</span> done
Starting uwsgi_img_classification <span style="color:#f92672">...</span> done
Attaching to nginx, uwsgi_img_classification
nginx    <span style="color:#f92672">|</span> <span style="color:#f92672">/</span>docker<span style="color:#f92672">-</span>entrypoint<span style="color:#f92672">.</span>sh: <span style="color:#f92672">/</span>docker<span style="color:#f92672">-</span>entrypoint<span style="color:#f92672">.</span>d<span style="color:#f92672">/</span> <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> empty, will attempt to perform configuration
nginx    <span style="color:#f92672">|</span> <span style="color:#f92672">/</span>docker<span style="color:#f92672">-</span>entrypoint<span style="color:#f92672">.</span>sh: Looking <span style="color:#66d9ef">for</span> shell scripts <span style="color:#f92672">in</span> <span style="color:#f92672">/</span>docker<span style="color:#f92672">-</span>entrypoint<span style="color:#f92672">.</span>d<span style="color:#f92672">/</span>
uwsgi_img_classification <span style="color:#f92672">|</span> [uWSGI] getting INI configuration <span style="color:#f92672">from</span> app.ini
<span style="color:#f92672">.....</span>
uwsgi_img_classification <span style="color:#f92672">|</span> <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">09</span>:<span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">12.292414</span>: I tensorflow<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>common_runtime<span style="color:#f92672">/</span>gpu<span style="color:#f92672">/</span>gpu_device<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">1402</span>] Created TensorFlow device (<span style="color:#f92672">/</span>job:localhost<span style="color:#f92672">/</span>replica:<span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>task:<span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>device:GPU:<span style="color:#ae81ff">0</span> <span style="color:#66d9ef">with</span> <span style="color:#ae81ff">4662</span> MB memory) <span style="color:#f92672">-&gt;</span> physical GPU (device: <span style="color:#ae81ff">0</span>, name: GeForce GTX <span style="color:#ae81ff">1660</span> Ti <span style="color:#66d9ef">with</span> Max<span style="color:#f92672">-</span>Q Design, pci bus id: <span style="color:#ae81ff">0000</span>:<span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">00.0</span>, compute capability: <span style="color:#ae81ff">7.5</span>)
uwsgi_img_classification <span style="color:#f92672">|</span> <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">09</span>:<span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">14.386546</span>: W tensorflow<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>framework<span style="color:#f92672">/</span>cpu_allocator_impl<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">81</span>] Allocation of <span style="color:#ae81ff">536870912</span> exceeds <span style="color:#ae81ff">10</span><span style="color:#f92672">%</span> of free system memory<span style="color:#f92672">.</span>
uwsgi_img_classification <span style="color:#f92672">|</span> <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">09</span>:<span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">14.737805</span>: W tensorflow<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>framework<span style="color:#f92672">/</span>cpu_allocator_impl<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">81</span>] Allocation of <span style="color:#ae81ff">536870912</span> exceeds <span style="color:#ae81ff">10</span><span style="color:#f92672">%</span> of free system memory<span style="color:#f92672">.</span>
uwsgi_img_classification <span style="color:#f92672">|</span> <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">09</span>:<span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">15.045424</span>: W tensorflow<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>framework<span style="color:#f92672">/</span>cpu_allocator_impl<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">81</span>] Allocation of <span style="color:#ae81ff">536870912</span> exceeds <span style="color:#ae81ff">10</span><span style="color:#f92672">%</span> of free system memory<span style="color:#f92672">.</span>
uwsgi_img_classification <span style="color:#f92672">|</span> <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">09</span>:<span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">16.238951</span>: W tensorflow<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>framework<span style="color:#f92672">/</span>cpu_allocator_impl<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">81</span>] Allocation of <span style="color:#ae81ff">536870912</span> exceeds <span style="color:#ae81ff">10</span><span style="color:#f92672">%</span> of free system memory<span style="color:#f92672">.</span>
uwsgi_img_classification <span style="color:#f92672">|</span> <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">09</span>:<span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">17.246651</span>: W tensorflow<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>framework<span style="color:#f92672">/</span>cpu_allocator_impl<span style="color:#f92672">.</span>cc:<span style="color:#ae81ff">81</span>] Allocation of <span style="color:#ae81ff">536870912</span> exceeds <span style="color:#ae81ff">10</span><span style="color:#f92672">%</span> of free system memory<span style="color:#f92672">.</span>
uwsgi_img_classification <span style="color:#f92672">|</span> WSGI app <span style="color:#ae81ff">0</span> (mountpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>) ready <span style="color:#f92672">in</span> <span style="color:#ae81ff">7</span> seconds on interpreter <span style="color:#ae81ff">0x56494b98c680</span> pid: <span style="color:#ae81ff">1</span> (default app)
uwsgi_img_classification <span style="color:#f92672">|</span> uWSGI running <span style="color:#66d9ef">as</span> root, you can use <span style="color:#f92672">--</span>uid<span style="color:#f92672">/--</span>gid<span style="color:#f92672">/--</span>chroot options
uwsgi_img_classification <span style="color:#f92672">|</span> <span style="color:#f92672">***</span> WARNING: you are running uWSGI <span style="color:#66d9ef">as</span> root <span style="color:#960050;background-color:#1e0010">!!!</span> (use the <span style="color:#f92672">--</span>uid flag) <span style="color:#f92672">***</span> 
uwsgi_img_classification <span style="color:#f92672">|</span> <span style="color:#f92672">***</span> uWSGI <span style="color:#f92672">is</span> running <span style="color:#f92672">in</span> multiple interpreter mode <span style="color:#f92672">***</span>
uwsgi_img_classification <span style="color:#f92672">|</span> spawned uWSGI worker <span style="color:#ae81ff">1</span> (<span style="color:#f92672">and</span> the only) (pid: <span style="color:#ae81ff">1</span>, cores: <span style="color:#ae81ff">1</span>)
</code></pre></div><p>Chạy client để nhận diện: <code>python client.py</code>.</p>
<p>Kết quả:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cat&#39;</span>
</code></pre></div><p><strong>8. Kết luận</strong></p>
<p>Phù, thật tuyệt vời, mọi thứ đã chạy đúng như mong muốn.</p>
<p>Bài hôm nay khá là dài và khó. Mình đã phải thực hiện cài cắm rất nhiều lần để có thể hoàn thành bài viết này. Hi vọng sẽ có ích cho các bạn trong việc tìm kiếm giải pháp triể n khải AI model vào trong các sản phẩm để đưa đến tay người dùng!</p>
<p>Toàn bộ source code sử dụng trong bài này, các bạn có thể tham khảo trên github cá nhân của mình tại <a href="https://github.com/tiensu/Model_Deployment/tree/master/docker">đây</a>. Giống như bài trước, vì model <code>animal_model_classification.h5</code> có dung lượng khá lớn (<em>&gt; 1.5GB</em>) nên mình không upload lên github được. Các bạn hãy sử dụng model của chính mình để thực hành nhé!</p>
<p>Trong các bài viết tiếp theo, mình sẽ tổng hợp lại các thuật toán Deep Learning, sau đó sẽ đi chi tiết vào một số thụât toán với các ứng dụng cụ thể. Mời các bạn đón đọc!</p>
<p><strong>7. Tham khảo</strong></p>
<ul>
<li><a href="https://www.docker.com/">Docker</a></li>
<li><a href="https://www.nginx.com/">Nginx</a></li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/">uWSGI</a></li>
<li><a href="https://flask.palletsprojects.com/en/1.1.x/">Flask</a></li>
<li><a href="https://theaisummer.com/docker/">AI Summer</a></li>
</ul>

        </div>

        
        
      </div>
    </div>
  </div>
</section>



<footer>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 text-center mb-5">
        <a href="https://tiensu.github.io/"><img src="https://tiensu.github.io/images/logo3.jpg" alt="SuNT&#39;s Blog | AI in Practical" style="height: auto"></a>
      </div>
               
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Contact Me</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="tel:0869644890"><i
                class="ti-mobile mr-3 text-primary"></i>0869644890</a></li>
          
                     
          <li class="mb-3"><i class="ti-location-pin mr-3 text-primary"></i>Hanoi, Vietnam</li>
          
                     
          <li class="mb-3"><a class="text-dark" href="mailto:tiensunguyen2103@gmail.com"><i
                class="ti-email mr-3 text-primary"></i>tiensunguyen2103@gmail.com</a>
          
          </li>
        </ul>
      </div>
      
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Social Contacts</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://www.facebook.com/tiensunguyen2103">Facebook</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://www.linkedin.com/in/su-nguyen-tien-aws%C2%AE-5ba74ba6/">Linkedin</a></li>
          
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Categories</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><a class="text-dark"
              href="/categories/algorithm-optimization">Algorithm Optimization</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/artificial-intelligent">Artificial Intelligent</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/convolution-neural-network">Convolution Neural Network</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/data-science">Data Science</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/deep-learning">Deep Learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/ebook">Ebook</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/ensemble-learning">Ensemble Learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/image-classification">Image classification</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/machine-learning">Machine Learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/model-deployment">Model deployment</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/neural-network">Neural Network</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/project-management">Project Management</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/text-classification">Text classification</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/xgboost">Xgboost</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Quick Links</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://tiensu.github.io/about">About</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://tiensu.github.io/blog">Post</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://tiensu.github.io/contact">Contact</a></li>
          
        </ul>
      </div>
      <div class="col-12 border-top py-4 text-center">
        | copyright © 2021 <a href="tiensu.github.io">SuNT</a>. All Rights Reserved |
      </div>
    </div>
  </div>
</footer>

<script>
  var indexURL = "https://tiensu.github.io/index.json"
</script>

<!-- JS Plugins -->

<script src="https://tiensu.github.io/plugins/jQuery/jquery.min.js"></script>

<script src="https://tiensu.github.io/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://tiensu.github.io/plugins/slick/slick.min.js"></script>

<script src="https://tiensu.github.io/plugins/venobox/venobox.min.js"></script>

<script src="https://tiensu.github.io/plugins/search/fuse.min.js"></script>

<script src="https://tiensu.github.io/plugins/search/mark.js"></script>

<script src="https://tiensu.github.io/plugins/search/search.js"></script>

<!-- Main Script -->

<script src="https://tiensu.github.io/js/script.min.js"></script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js"></script>
<div id="js-cookie-box" class="cookie-box cookie-box-hide">
	This site uses cookies. By continuing to use this website, you agree to their use. <span id="js-cookie-button" class="btn btn-sm btn-primary ml-2">I Accept</span>
</div>
<script>
	(function ($) {
		const cookieBox = document.getElementById('js-cookie-box');
		const cookieButton = document.getElementById('js-cookie-button');
		if (!Cookies.get('cookie-box')) {
			cookieBox.classList.remove('cookie-box-hide');
			cookieButton.onclick = function () {
				Cookies.set('cookie-box', true, {
					expires:  2 
				});
				cookieBox.classList.add('cookie-box-hide');
			};
		}
	})(jQuery);
</script>


<style>
.cookie-box {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  text-align: center;
  z-index: 9999;
  padding: 1rem 2rem;
  background: rgb(71, 71, 71);
  transition: all .75s cubic-bezier(.19, 1, .22, 1);
  color: #fdfdfd;
}

.cookie-box-hide {
  display: none;
}
</style>
</body>
</html>