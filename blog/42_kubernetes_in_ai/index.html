<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <title>SuNT&#39;s Blog | AI in Practical</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="This is meta description">
  <meta name="author" content="SuNT">
  <meta name="generator" content="Hugo 0.68.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/slick/slick.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/themify-icons/themify-icons.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/plugins/venobox/venobox.css ">
  
  <link rel="stylesheet" href="https://tiensu.github.io/css/override.css">
  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://tiensu.github.io/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://tiensu.github.io/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://tiensu.github.io/images/favicon.png " type="image/x-icon">

  <!-- google analitycs -->
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'Your ID', 'auto');
    ga('send', 'pageview');
  </script>

</head><body>
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0">
      <a class="navbar-brand mobile-view" href="https://tiensu.github.io/"><img class="img-fluid"
          src="https://tiensu.github.io/images/logo3.jpg" alt="SuNT&#39;s Blog | AI in Practical"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu h3"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <div class="desktop-view">
          <ul class="navbar-nav mr-auto">
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.facebook.com/tiensunguyen2103"><i class="ti-facebook"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.linkedin.com/in/su-nguyen-tien-aws%C2%AE-5ba74ba6/"><i class="ti-linkedin"></i></a>
            </li>
            
          </ul>
        </div>

        <a class="navbar-brand mx-auto desktop-view" href="https://tiensu.github.io/"><img class="img-fluid"
            src="https://tiensu.github.io/images/logo3.jpg" alt="SuNT&#39;s Blog | AI in Practical"></a>

        <ul class="navbar-nav">
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://tiensu.github.io/about">About</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://tiensu.github.io/blog">Post</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://tiensu.github.io/contact">Contact</a>
          </li>
          
          
        </ul>

        
        <!-- search -->
        <div class="search pl-lg-4">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://tiensu.github.io//search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        

        
      </div>
    </nav>
  </div>
  <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
      document.querySelectorAll("mjx-container").forEach(function(x){
        x.parentElement.classList += 'has-jax'})
    });

</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</header>
<!-- /navigation -->

<section class="section-sm">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        
        <a href="/categories/model-deployment"
          class="text-primary">Model deployment</a>
        
        <a href="/categories/kubernetes"
          class="text-primary">Kubernetes</a>
        
        <a href="/categories/docker"
          class="text-primary">Docker</a>
        
        <h2>Tìm hiểu về Kubernetes và áp dụng vào bài toán AI - Phần 1: Kubernetes Pod</h2>
        <div class="mb-3 post-meta">
          <span>By SuNT</span>
          
          <span class="border-bottom border-primary px-2 mx-1"></span>
          <span>18 January 2021</span>
          
        </div>
        
        <img src="https://tiensu.github.io/images/featured-post/kubernetes-architecture.png" class="img-fluid w-100 mb-4" alt="Tìm hiểu về Kubernetes và áp dụng vào bài toán AI - Phần 1: Kubernetes Pod">
        
        <div class="content mb-5">
          <p>Trong các bài viết trước, mình đã giới thiệu về Docker, sử dụng kết hợp với Nginx, uWSGI, Flask để deploy model trong môi trường production.
Nhìn chung mà nói, cách kết hợp 4 dịch vụ này đủ để áp ứng cho hầu hết các bài toán AI, ngoại trừ vấn đề cấu hình tương đối phức tạp và khó triển khai trên cloud (thực tế là AWS và GCP đề không hỗ trợ cách này, nếu muốn chúng ta vẫn phải cấu hình bằng tay như dưới local).</p>
<p>Gần đây, Kubernetes nổi lên như là một xu hướng mới, đáp ứng đầy đủ các yêu cầu của việc triển khai model trong môi trường production. Hơn thế nữa, việc cấu hình rất đơn giản và được hỗ trợ bởi các ông lớn cloud (AWS và GCP đều có dịch vụ Kubernetes). Trong loạt bài tiếp theo, mình sẽ cùng mọi người tìm hiểu về <code>hot trend</code> này và cách thức sử dụng nó để deploy các AI model của chúng ta nhé!</p>
<p><strong>1. Kubernetes là gì?</strong></p>
<p>Theo định nghĩa từ <a href="https://kubernetes.io/">trang chủ</a> của Kubernetes thì:</p>
<p><code>Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications.</code></p>
<p>Phần tử hạt nhân của Kubernetes chính là các Containers (<em>Docker Container</em>). Nói theo một cách khác, Kubernetes giúp chúng ta:</p>
<ul>
<li><strong>Manage containers</strong>: Quản lý đồng thời nhiều <code>docker containers</code> của cùng một ứng dụng hoặc thậm chí là nhiều ứng dụng khác nhau.</li>
<li><strong>Manage lifecycle</strong>: Quản lý toàn bộ lifecycle của các containers, từ lúc được tạo ra đến khi bị xóa bỏ.</li>
<li><strong>Hardware optimization</strong>: Tối ưu hóa, tối đa hóa khả năng của phần cứng thiết bị.</li>
<li><strong>Schedule</strong>: Lập lịch khi nào cần bật/tắt containers.</li>
<li><strong>Load balancer</strong>: Phân tải xử lý đều cho các containers.</li>
<li><strong>Backup</strong>: Khi một container chết, sẽ có một container khác đươc tạo để thay thế.</li>
<li><strong>Scalling</strong>: Dễ dàng scale các containers up/down theo một trong 2 chế độ: tự động hoặc bằng tay.</li>
<li><strong>Monitor system</strong>: Dễ dàng giám sát hoạt động của toàn bộ hệ thống.</li>
</ul>
<p>Việc cấu hình cho Kubernetes khá đơn giản, tất cả chỉ thông qua một file cấu hình duy nhất.</p>
<p>Trong tiếng Hy Lạp, Kubernetes có nghĩa là <code>người chỉ huy</code> hay <code>thuyền trưởng</code>.</p>
<p>Tất cả những đặc điểm trên đều phù hợp với giải pháp mà chúng ta tìm kiếm để đưa AI model vào môi trường production. Tất nhiên là phạm vi ứng dụng của Kubernetes còn rộng lớn hơn rất nhiều, nhưng trong lĩnh vực làm việc và nghiên cứu của mình, mình chỉ tập trung tìm hiểu và sử dụng Kubernetes cho các bài toán về AI.</p>
<p><strong>2. Kiến trúc và thành phần của Kubernetes</strong></p>


<div style="text-align:center">
    <img style="height:auto" src="/images/post/kubernetes_architecture.jpg">
</div>


<p>Kubernetes bao gòm các Nodes, được chia thành 2 loại: Master Node và Worker Nodes. Master Nodes chịu trách nhiệm quản lý các Worker Nodes, trong khi các Worker Nodes làm nhiệm vụ thực hiện các công việc tính toán, &hellip; Mỗi Worker Node lại được chia nhỏ thành các Pods, và trong mỗi Pod chính là các Containers.</p>
<p>Phần còn lại của bài hôm nay, mình sẽ cùng các bạn tìm hiểu về Pod. Các bài tiếp theo, chúng ta sẽ làm việc với Job, CronJob, Deployment, Service.</p>
<p><strong>3. Kubernetes Pod</strong></p>
<p><em><strong>3.1 Kubernetes Pod là gì?</strong></em></p>
<p>Theo định nghĩa, Pod là đối tượng nhỏ nhất có khả năng triển khai trong kiến trúc của Kubernetes, tức là bạn có thể tạo, sử dụng, hay xóa Pod. Có thể coi Pod chính là đại diện của một ứng dụng (<em>instance application</em>) chạy trong Kubernetes.</p>
<p>Như đã nói ở phần 2, mỗi Pod chứa một hoặc nhiều Containers để thực hiện một công việc (<em>Job</em>) nào đó. Các Containers trong cùng Pod nằm trong cùng một mạng local và chia sẻ tài nguyên sử dụng với nhau. Chính vì thế mà chúng dễ dàng giao tiếp và làm việc với nhau.</p>
<p>Vì Pod là Single Instance của ứng dụng chạy trong Kebernetes, số lượng Pod được tạo ra hay xóa đi một cách tự động (<em>Load Balancing &amp; Failure Recovery</em>), tùy theo tải mà ứng dụng phải phục vụ.</p>
<p><em><strong>3.2 Tạo Pod từ Docker Image có sẵn</strong></em></p>
<p>Để làm việc được với Pod, trước tiên cần phải cài đặt <code>kubectl</code> theo hướng dẫn trên trang chủ của Kubernetes tại <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">đây</a> hoặc tại <a href="https://computingforgeeks.com/deploy-kubernetes-cluster-on-ubuntu-with-kubeadm/">đây</a></p>
<p>Cách dễ nhất để tạo và triển khai Kubernetes là sử dụng config file. File này sẽ chỉ định đối tượng được tạo là gì, các metadata gắn với đối tượng đó, tài nguyên cần thiết là bao nhiêu, &hellip;</p>
<p>Dưới đây là template của config file (<em>pod_public.yaml</em>) để tạo một Pod:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">apiVersion: v1
kind: Pod
metadata:
  name: python3<span style="color:#f92672">-</span>pod
  labels:
    app: python3
spec:
  containers:
  <span style="color:#f92672">-</span> name: python3<span style="color:#f92672">-</span>container
    image: python:<span style="color:#ae81ff">3.6</span>
    command: [<span style="color:#e6db74">&#39;python3&#39;</span>, <span style="color:#e6db74">&#39;-c&#39;</span>, <span style="color:#e6db74">&#39;print(&#34;Hello, World!&#34;)&#39;</span>]
  restartPolicy: Never
</code></pre></div><p>File config này bao gồm những thông tin sau:</p>
<ul>
<li><strong>apiVersion</strong>: Phiên bản của <a href="https://kubernetes.io/docs/concepts/overview/kubernetes-api/#api-versioning">Kubernetes API</a> đang sử dụng.</li>
<li><strong>kind</strong>: Loại tài nguyên (<em>đối tượng</em>) của Kubernetes được tạo ra: Pod, Job, Development, &hellip; Ở đây là Pod object.</li>
<li><strong>metadata</strong>: Là một tập hợp các <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/">labels</a> và các thuộc tính của model mà người phát triển có thể thêm vào tùy ý giống như phiên bản, độ chính xác, thuật toán, &hellip;</li>
<li><strong>spec</strong>: Bao gồm thông tin của các Containers chạy bên trong Pod: tên, docker image, command. Như trong cấu hình hiện tại thì chỉ có 1 Container.</li>
<li><strong>restartPolicy</strong>: Cho phép Container có restart hay không khi nó bị lỗi. Giá trị <code>never</code> ở đây tức là không cho phép restart.</li>
</ul>
<p>Thực hiên lệnh sau để tạo Pod:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl create <span style="color:#f92672">-</span>f pod_public<span style="color:#f92672">.</span>yaml
pod <span style="color:#e6db74">&#34;python3-pod&#34;</span> created
</code></pre></div><p>Kiểm tra trạng thái của pod vừa tạo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl get pods
NAME        READY     STATUS      RESTARTS   AGE
python3<span style="color:#f92672">-</span>pod   <span style="color:#ae81ff">0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>       Completed   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">3</span>s
</code></pre></div><p>Xem log của pod vừa tạo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl logs python3<span style="color:#f92672">-</span>pod
Hello, World<span style="color:#960050;background-color:#1e0010">!</span>
</code></pre></div><p>Xóa pod vừa tạo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl delete <span style="color:#f92672">-</span>f pod_public<span style="color:#f92672">.</span>yaml
pod <span style="color:#e6db74">&#34;python3-pod&#34;</span> deleted
</code></pre></div><p><em><strong>3.3 Tạo Pod từ Docker Image tự tạo</strong></em></p>
<p>Mình sẽ sử dụng Docker Image đã tạo từ bài <a href="https://tiensu.github.io/blog/39_package_ai_model_using_docker_batch_inference/">này</a> để đưa vào Pod.</p>
<p>Trước tiên, bạn hãy login vào <a href="https://hub.docker.com/">Docker Hub</a> để tạo một Repository. Giả sử mình tạo Repository tên là <code>ml-model-batch-infer</code>.</p>
<p>ở máy local, thực hiện các bước sau để đưa Docker Image đã tạo lên Repository:</p>
<ul>
<li>Login vào Docker Hub</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> docker login <span style="color:#f92672">-</span>u tiensu
</code></pre></div><p>Trong đó, <code>tiensu</code> là tên đăng nhập của mình, bạn hãy thay bằng tên đăng nhập của bạn. Nhập mật khẩu khi được hỏi.</p>
<ul>
<li>Gán Tag cho Docker Image theo tên mới trên Repository</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">docker tag docker<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer:latest tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>refer:latest
</code></pre></div><ul>
<li>Push Docker Image đã gắn Tag lên Repository</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">docker push tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer:latest
</code></pre></div><p>Output:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">The push refers to repository [docker<span style="color:#f92672">.</span>io<span style="color:#f92672">/</span>tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer]
<span style="color:#ae81ff">2</span>a0a8f09fca2: Pushed 
ea3e588d9e9f: Pushed 
<span style="color:#ae81ff">2</span>b8e8179f02d: Pushed 
<span style="color:#ae81ff">254</span>c54a05297: Pushed 
bdeb303132f3: Pushed 
<span style="color:#ae81ff">5</span>f70bf18a086: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">6</span>f5a41ae77fd: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">5</span>a1b9a3f9355: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
b1d7816bac14: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
c91fed2d1998: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
cc70098d00e3: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">88727e93</span>cbac: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
cadaf24035f3: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">8</span>f170f4774e3: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">33</span>bd52db887f: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">21e5</span>dd010f50: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
ea370ab22368: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">421</span>d1408f872: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">18</span>fd1ca0de51: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">8</span>f01aab6d756: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
e18a1c4e1d31: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">8552</span>f27c3cd8: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">1</span>a4c57efcc23: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">94</span>b8fe888eac: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">02473</span>afd360b: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
dbf2c0f42a39: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
<span style="color:#ae81ff">9</span>f32931c9d28: Mounted <span style="color:#f92672">from</span> jupyter<span style="color:#f92672">/</span>scipy<span style="color:#f92672">-</span>notebook 
latest: digest: sha256:<span style="color:#ae81ff">2552</span>cb24c104d9b4fe3a43cc952371a7a1b0cce84e1c95821622b4fe508a6877 size: <span style="color:#ae81ff">6786</span>
</code></pre></div><p>Để tạo Pod với Docker Image này, cập nhật lại file config (<em>đổi tên thành pod_custom.yaml</em>) của Pod như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">apiVersion: v1
kind: Pod
metadata:
  name: pod<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer
  labels:
    app: python3
spec:
  containers:
  <span style="color:#f92672">-</span> name: container<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer
    image: tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer:latest
    command:  [<span style="color:#e6db74">&#39;python3&#39;</span>, <span style="color:#e6db74">&#39;batch_inference.py&#39;</span>]
  restartPolicy: Never
</code></pre></div><p>Chạy lệnh sau để tạo Pod:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl create <span style="color:#f92672">-</span>f pod_custom<span style="color:#f92672">.</span>yaml
pod<span style="color:#f92672">/</span>pod<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer created
</code></pre></div><p>Kiểm tra trạng thái của Pod vừa tạo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl get pods
NAME                       READY   STATUS      RESTARTS   AGE
command<span style="color:#f92672">-</span>demo               <span style="color:#ae81ff">0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     Completed   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">113</span>m
pod<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer   <span style="color:#ae81ff">0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     Completed   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">5</span>m28s
python3<span style="color:#f92672">-</span>pod                <span style="color:#ae81ff">0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     Completed   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">90</span>m
</code></pre></div><p>Chú ý là Docker Image của chúng ta được tải về trên Worker Node. Bạn có thể kiểm tra trên đó bằng lệnh <code>$ docker ps</code>.</p>
<p>Chúng ta có thể xem miêu tả chi tiết quá trình tạo Pod như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl describe pod pod<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer
Name:         pod<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer
Namespace:    default
Priority:     <span style="color:#ae81ff">0</span>
Node:         duynm<span style="color:#f92672">-</span>vostro<span style="color:#f92672">-</span><span style="color:#ae81ff">3670</span><span style="color:#f92672">/</span><span style="color:#ae81ff">10.1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">34.169</span>
Start Time:   Wed, <span style="color:#ae81ff">27</span> Jan <span style="color:#ae81ff">2021</span> <span style="color:#ae81ff">16</span>:<span style="color:#ae81ff">44</span>:<span style="color:#ae81ff">15</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0700</span>
Labels:       app<span style="color:#f92672">=</span>python3
Annotations:  cni<span style="color:#f92672">.</span>projectcalico<span style="color:#f92672">.</span>org<span style="color:#f92672">/</span>podIP: 
              cni<span style="color:#f92672">.</span>projectcalico<span style="color:#f92672">.</span>org<span style="color:#f92672">/</span>podIPs: 
Status:       Succeeded
IP:           <span style="color:#ae81ff">192.168</span><span style="color:#f92672">.</span><span style="color:#ae81ff">24.198</span>
IPs:
  IP:  <span style="color:#ae81ff">192.168</span><span style="color:#f92672">.</span><span style="color:#ae81ff">24.198</span>
Containers:
  container<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer:
    Container ID:  docker:<span style="color:#f92672">//</span><span style="color:#ae81ff">535749</span>cae10e6dd605030b6d84ba978cc245bfd44bb6981d3307a3ffa8a5bf94
    Image:         tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer:latest
    Image ID:      docker<span style="color:#f92672">-</span>pullable:<span style="color:#f92672">//</span>tiensu<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer<span style="color:#a6e22e">@sha256</span>:<span style="color:#ae81ff">2552</span>cb24c104d9b4fe3a43cc952371a7a1b0cce84e1c95821622b4fe508a6877
    Port:          <span style="color:#f92672">&lt;</span>none<span style="color:#f92672">&gt;</span>
    Host Port:     <span style="color:#f92672">&lt;</span>none<span style="color:#f92672">&gt;</span>
    Command:
      python3
      batch_inference<span style="color:#f92672">.</span>py
    State:          Terminated
      Reason:       Completed
      Exit Code:    <span style="color:#ae81ff">0</span>
      Started:      Wed, <span style="color:#ae81ff">27</span> Jan <span style="color:#ae81ff">2021</span> <span style="color:#ae81ff">16</span>:<span style="color:#ae81ff">44</span>:<span style="color:#ae81ff">24</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0700</span>
      Finished:     Wed, <span style="color:#ae81ff">27</span> Jan <span style="color:#ae81ff">2021</span> <span style="color:#ae81ff">16</span>:<span style="color:#ae81ff">44</span>:<span style="color:#ae81ff">24</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0700</span>
    Ready:          False
    Restart Count:  <span style="color:#ae81ff">0</span>
    Environment:    <span style="color:#f92672">&lt;</span>none<span style="color:#f92672">&gt;</span>
    Mounts:
      <span style="color:#f92672">/</span>var<span style="color:#f92672">/</span>run<span style="color:#f92672">/</span>secrets<span style="color:#f92672">/</span>kubernetes<span style="color:#f92672">.</span>io<span style="color:#f92672">/</span>serviceaccount <span style="color:#f92672">from</span> default<span style="color:#f92672">-</span>token<span style="color:#f92672">-</span>gmswp (ro)
Conditions:
  Type              Status
  Initialized       True 
  Ready             False 
  ContainersReady   False 
  PodScheduled      True 
Volumes:
  default<span style="color:#f92672">-</span>token<span style="color:#f92672">-</span>gmswp:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default<span style="color:#f92672">-</span>token<span style="color:#f92672">-</span>gmswp
    Optional:    false
QoS Class:       BestEffort
Node<span style="color:#f92672">-</span>Selectors:  <span style="color:#f92672">&lt;</span>none<span style="color:#f92672">&gt;</span>
Tolerations:     node<span style="color:#f92672">.</span>kubernetes<span style="color:#f92672">.</span>io<span style="color:#f92672">/</span><span style="color:#f92672">not</span><span style="color:#f92672">-</span>ready:NoExecute op<span style="color:#f92672">=</span>Exists <span style="color:#66d9ef">for</span> <span style="color:#ae81ff">300</span>s
                 node<span style="color:#f92672">.</span>kubernetes<span style="color:#f92672">.</span>io<span style="color:#f92672">/</span>unreachable:NoExecute op<span style="color:#f92672">=</span>Exists <span style="color:#66d9ef">for</span> <span style="color:#ae81ff">300</span>s
Events:
  Type    Reason     Age    From               Message
  <span style="color:#f92672">----</span>    <span style="color:#f92672">------</span>     <span style="color:#f92672">----</span>   <span style="color:#f92672">----</span>               <span style="color:#f92672">-------</span>
  Normal  Scheduled  <span style="color:#ae81ff">4</span>m18s  default<span style="color:#f92672">-</span>scheduler  Successfully assigned default<span style="color:#f92672">/</span>pod<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer to duynm<span style="color:#f92672">-</span>vostro<span style="color:#f92672">-</span><span style="color:#ae81ff">3670</span>
  Normal  Pulling    <span style="color:#ae81ff">4</span>m15s  kubelet            Pulling image <span style="color:#e6db74">&#34;tiensu/ml-model-batch-infer:latest&#34;</span>
  Normal  Pulled     <span style="color:#ae81ff">4</span>m11s  kubelet            Successfully pulled image <span style="color:#e6db74">&#34;tiensu/ml-model-batch-infer:latest&#34;</span> <span style="color:#f92672">in</span> <span style="color:#ae81ff">4.353859959</span>s
  Normal  Created    <span style="color:#ae81ff">4</span>m9s   kubelet            Created container container<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer
  Normal  Started    <span style="color:#ae81ff">4</span>m9s   kubelet            Started container container<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer
</code></pre></div><p>Cuối cùng, hãy xem log tạo ra khi thực hiên Inference:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> kubectl logs pod<span style="color:#f92672">-</span>ml<span style="color:#f92672">-</span>model<span style="color:#f92672">-</span>batch<span style="color:#f92672">-</span>infer
Running inference<span style="color:#f92672">...</span>
Loading data<span style="color:#f92672">...</span>
Loading model from: <span style="color:#f92672">/</span>code<span style="color:#f92672">/</span>model<span style="color:#f92672">/</span>clf<span style="color:#f92672">.</span>joblib
Scoring observations<span style="color:#f92672">...</span>
[<span style="color:#ae81ff">15.32448686</span> <span style="color:#ae81ff">27.68741572</span> <span style="color:#ae81ff">24.20025598</span> <span style="color:#ae81ff">31.94786177</span> <span style="color:#ae81ff">10.42732759</span> <span style="color:#ae81ff">34.12058193</span>
 <span style="color:#ae81ff">22.05210667</span> <span style="color:#ae81ff">11.58265489</span> <span style="color:#ae81ff">13.1649368</span>  <span style="color:#ae81ff">42.84036647</span> <span style="color:#ae81ff">33.03218733</span> <span style="color:#ae81ff">15.77635169</span>
 <span style="color:#ae81ff">23.93521876</span> <span style="color:#ae81ff">19.91587166</span> <span style="color:#ae81ff">25.43466604</span> <span style="color:#ae81ff">20.55132127</span> <span style="color:#ae81ff">13.65254047</span> <span style="color:#ae81ff">47.47279364</span>
 <span style="color:#ae81ff">17.58214889</span> <span style="color:#ae81ff">21.51806638</span> <span style="color:#ae81ff">22.57388848</span> <span style="color:#ae81ff">16.97645106</span> <span style="color:#ae81ff">16.25503893</span> <span style="color:#ae81ff">20.57862843</span>
 <span style="color:#ae81ff">14.57438158</span> <span style="color:#ae81ff">11.81385445</span> <span style="color:#ae81ff">24.78353556</span> <span style="color:#ae81ff">37.65978361</span> <span style="color:#ae81ff">30.18436261</span> <span style="color:#ae81ff">19.67895051</span>
 <span style="color:#ae81ff">23.22841646</span> <span style="color:#ae81ff">24.94197905</span> <span style="color:#ae81ff">18.65459129</span> <span style="color:#ae81ff">30.19731636</span>  <span style="color:#ae81ff">8.9560549</span>  <span style="color:#ae81ff">13.8130382</span>
 <span style="color:#ae81ff">14.23277857</span> <span style="color:#ae81ff">17.3840622</span>  <span style="color:#ae81ff">19.83840166</span> <span style="color:#ae81ff">24.91315811</span> <span style="color:#ae81ff">20.44991809</span> <span style="color:#ae81ff">15.32433651</span>
 <span style="color:#ae81ff">25.8157052</span>  <span style="color:#ae81ff">16.47533793</span> <span style="color:#ae81ff">19.2214524</span>  <span style="color:#ae81ff">19.87110293</span> <span style="color:#ae81ff">21.47113681</span> <span style="color:#ae81ff">21.56443118</span>
 <span style="color:#ae81ff">24.64517965</span> <span style="color:#ae81ff">22.43665872</span> <span style="color:#ae81ff">22.18289286</span>]
</code></pre></div><p><strong>7. Kết luận</strong></p>
<p>Mặc dù Pod là đối tượng quan trọng, không thể thiếu trong bất kỳ kiến trúc Kubernetes nào nhưng các <code>Best Practice</code> đều không khuyến khích việc sử dung nó một cách trực tiếp, mà nên được triển khai cùng với các đối tượng khác ở mức cao hơn của Kubernetes để quản lý nó, như Job chẳng hạn. Job sẽ tạo ra một hoặc nhiều Pods, và khi một Pod bị chết thì Pod khác sẽ được bật lên để sẵn sàng thay thế cho nó.</p>
<p>Chúng ta sẽ tìm hiểu vấn đề này trong bài viết tiếp theo. Mời các bạn đón đọc!</p>
<p>Source code của bài này các bạn tham khảo tại <a href="https://github.com/tiensu/Model_Deployment/tree/master/kubernetes_pod">đây</a>.</p>
<p><strong>8. Tham khảo</strong></p>
<ul>
<li><a href="https://mlinproduction.com/k8s-pods/">Mlinproduction</a></li>
<li><a href="https://mlinproduction.com/k8s-pods/">Docker Hub</a></li>
</ul>

        </div>

        
        
      </div>
    </div>
  </div>
</section>



<footer>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 text-center mb-5">
        <a href="https://tiensu.github.io/"><img src="https://tiensu.github.io/images/logo3.jpg" alt="SuNT&#39;s Blog | AI in Practical" style="height: auto"></a>
      </div>
               
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Contact Me</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="tel:0869644890"><i
                class="ti-mobile mr-3 text-primary"></i>0869644890</a></li>
          
                     
          <li class="mb-3"><i class="ti-location-pin mr-3 text-primary"></i>Hanoi, Vietnam</li>
          
                     
          <li class="mb-3"><a class="text-dark" href="mailto:tiensunguyen2103@gmail.com"><i
                class="ti-email mr-3 text-primary"></i>tiensunguyen2103@gmail.com</a>
          
          </li>
        </ul>
      </div>
      
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Social Contacts</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://www.facebook.com/tiensunguyen2103">Facebook</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://www.linkedin.com/in/su-nguyen-tien-aws%C2%AE-5ba74ba6/">Linkedin</a></li>
          
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Categories</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><a class="text-dark"
              href="/categories/algorithm-optimization">Algorithm Optimization</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/autoencoder">Autoencoder</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/convolution-neural-network">Convolution Neural Network</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/data-driff">Data driff</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/data-science">Data Science</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/deep-learning">Deep Learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/docker">Docker</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/ebook">Ebook</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/ensemble-learning">Ensemble Learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/face-recognition">Face recognition</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/image-classification">Image classification</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/kubernetes">Kubernetes</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/machine-learning">Machine Learning</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/model-deployment">Model deployment</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/neural-network">Neural Network</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/project-management">Project Management</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/scalability">Scalability</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/text-classification">Text Classification</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/xgboost">Xgboost</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Quick Links</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://tiensu.github.io/about">About</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://tiensu.github.io/blog">Post</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://tiensu.github.io/contact">Contact</a></li>
          
        </ul>
      </div>
      <div class="col-12 border-top py-4 text-center">
        | copyright © 2021 <a href="tiensu.github.io">SuNT</a>. All Rights Reserved |
      </div>
    </div>
  </div>
</footer>

<script>
  var indexURL = "https://tiensu.github.io/index.json"
</script>

<!-- JS Plugins -->

<script src="https://tiensu.github.io/plugins/jQuery/jquery.min.js"></script>

<script src="https://tiensu.github.io/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://tiensu.github.io/plugins/slick/slick.min.js"></script>

<script src="https://tiensu.github.io/plugins/venobox/venobox.min.js"></script>

<script src="https://tiensu.github.io/plugins/search/fuse.min.js"></script>

<script src="https://tiensu.github.io/plugins/search/mark.js"></script>

<script src="https://tiensu.github.io/plugins/search/search.js"></script>

<!-- Main Script -->

<script src="https://tiensu.github.io/js/script.min.js"></script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js"></script>
<div id="js-cookie-box" class="cookie-box cookie-box-hide">
	This site uses cookies. By continuing to use this website, you agree to their use. <span id="js-cookie-button" class="btn btn-sm btn-primary ml-2">I Accept</span>
</div>
<script>
	(function ($) {
		const cookieBox = document.getElementById('js-cookie-box');
		const cookieButton = document.getElementById('js-cookie-button');
		if (!Cookies.get('cookie-box')) {
			cookieBox.classList.remove('cookie-box-hide');
			cookieButton.onclick = function () {
				Cookies.set('cookie-box', true, {
					expires:  2 
				});
				cookieBox.classList.add('cookie-box-hide');
			};
		}
	})(jQuery);
</script>


<style>
.cookie-box {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  text-align: center;
  z-index: 9999;
  padding: 1rem 2rem;
  background: rgb(71, 71, 71);
  transition: all .75s cubic-bezier(.19, 1, .22, 1);
  color: #fdfdfd;
}

.cookie-box-hide {
  display: none;
}
</style>
</body>
</html>