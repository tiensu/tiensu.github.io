<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="format-detection" content="telephone=no" />

    <title>
        XGBoost - Bài 14: Tuning Subsample | ML in Practical
    </title>


    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#ffffff" />


    <link rel="stylesheet" href="https://unpkg.com/modern-normalize@0.6.0/modern-normalize.css" />





    <link rel="stylesheet" href="https://tiensu.github.io/style.min.388cbd0ce358245ec0dfcee3b8889b3cc50e2bb8a5b2bcd40f8bd092ebefb81a.css" integrity="sha256-OIy9DONYJF7A387juIibPMUOK7ilsrzUD4vQkuvvuBo=" />




    <script type="application/javascript">
        var doNotTrack = false;
        if (!doNotTrack) {
            (function(i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r;
                i[r] = i[r] || function() {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
                a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
            ga('create', 'UA-180180568-1', 'auto');
            ga('set', 'anonymizeIp', true);
            ga('send', 'pageview');
        }
    </script>


</head>

<body>
    <header id="header">

        <script type="application/javascript">
            var doNotTrack = false;
            if (!doNotTrack) {
                (function(i, s, o, g, r, a, m) {
                    i['GoogleAnalyticsObject'] = r;
                    i[r] = i[r] || function() {
                        (i[r].q = i[r].q || []).push(arguments)
                    }, i[r].l = 1 * new Date();
                    a = s.createElement(o),
                        m = s.getElementsByTagName(o)[0];
                    a.async = 1;
                    a.src = g;
                    m.parentNode.insertBefore(a, m)
                })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
                ga('create', 'UA-180180568-1', 'auto');
                ga('set', 'anonymizeIp', true);
                ga('send', 'pageview');
            }
        </script>

        <div class="header_container">
            <h1 class="sitetitle">
                <a href="https://tiensu.github.io/" title="ML in Practical">ML in Practical</a>
            </h1>
            <nav class="navbar">
                <ul>
                    <li><a href="https://tiensu.github.io/">Home</a></li>

                    <li>
                        <a href="/about/">

                            <span>About</span>
                        </a>
                    </li>

                    <li>
                        <a href="/tags/">

                            <span>Tags</span>
                        </a>
                    </li>

                    <li>
                        <a href="/archives/">

                            <span>Archives</span>
                        </a>
                    </li>

                    <li class="hide-sm"><a href="https://tiensu.github.io/index.xml" type="application/rss+xml">RSS</a></li>
                </ul>
            </nav>
        </div>
        <script>
            MathJax = {
                tex: {
                    inlineMath: [
                        ['$', '$'],
                        ['\\(', '\\)']
                    ],
                    displayMath: [
                        ['$$', '$$'],
                        ['\\[', '\\]']
                    ],
                    processEscapes: true,
                    processEnvironments: true
                },
                options: {
                    skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
                }
            };

            window.addEventListener('load', (event) => {
                document.querySelectorAll("mjx-container").forEach(function(x) {
                    x.parentElement.classList += 'has-jax'
                })
            });
        </script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>


    </header>


    <section id="main">
        <article class="post content">
            <h2 class="title">XGBoost - Bài 14: Tuning Subsample</h2>
            <div class="post_content">
                <p>Trong quá trình training, XGBoost thường xuyên phải thực hiện công việc chọn lựa ngẫu nhiên tập dữ liệu con (subsamples) từ tập dữ liệu gốc ban đầu. Các kỹ thuật để làm việc này được gọi bằng cái tên <code>Stochastic Gradient Boosting</code>                    (<em>SGB</em>).</p>
                <p>Trong bài này chúng ta sẽ cùng tìm hiểu về SGB và tuning SGB để tìm ra kỹ thuật phù hợp với bài toán.</p>
                <p><strong>1. Tuning Row Subsampling</strong></p>
                <p><code>Row subsampling</code> liên quan đến việc chọn ngẫu nhiên các samples từ tập <code>train set</code>. Trong XGBoost, giá trị của <code>row subsampling</code> được chỉ ra bởi tham số <code>subsample</code>. Giá trị mặc định là 1, nghĩa
                    là sử dụng toàn bộ tập <code>train set</code>, không <code>subsampling</code>.</p>
                <p>Tiếp tục sử dụng tập <a href="https://www.kaggle.com/c/otto-group-product-classification-challenge/data">Otto dataset</a>, chúng ta sẽ grid-search tham số <code>subsample</code> với các giá trị như sau: <strong>[0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 1.0]</strong>.</p>
                <p>Có 9 giá trị của <code>subsample</code>, mỗi model sẽ được đánh giá sử dụng 10-fold cross-validation. Như vậy, có 9x10=90 models cần phải trained.</p>
                <p>Code đầy đủ như sau:</p>
                <div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># XGBoost on Otto dataset, tune subsample</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">read_csv</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>

<span class="c1"># load data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;train.csv&#39;</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># split data into X and y</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">94</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[:,</span><span class="mi">94</span><span class="p">]</span>

<span class="c1"># encode string class values as integers</span>
<span class="n">label_encoded_y</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># grid search</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">()</span>
<span class="n">subsample</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">subsample</span><span class="o">=</span><span class="n">subsample</span><span class="p">)</span>
<span class="n">kfold</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s2">&#34;accuracy&#34;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kfold</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">grid_result</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">label_encoded_y</span><span class="p">)</span>

<span class="c1"># summarize results</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Best: </span><span class="si">%f</span><span class="s2"> using </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">grid_result</span><span class="o">.</span><span class="n">best_score_</span><span class="p">,</span> <span class="n">grid_result</span><span class="o">.</span><span class="n">best_params_</span><span class="p">))</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">grid_result</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;mean_test_score&#39;</span><span class="p">]</span>
<span class="n">stds</span> <span class="o">=</span> <span class="n">grid_result</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;std_test_score&#39;</span><span class="p">]</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">grid_result</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stdev</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%f</span><span class="s2"> (</span><span class="si">%f</span><span class="s2">) with: </span><span class="si">%r</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">stdev</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span>

<span class="c1"># plot</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">subsample</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">stds</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;XGBoost subsample vs accuracy&#34;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;subsample&#39;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;subsample.png&#39;</span><span class="p">)</span>
</code></pre></div>
                <p>Kết quả chạy:</p>
                <div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">Fitting</span> <span class="mi">10</span> <span class="n">folds</span> <span class="k">for</span> <span class="n">each</span> <span class="n">of</span> <span class="mi">9</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">totalling</span> <span class="mi">90</span> <span class="n">fits</span>
<span class="p">[</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]:</span> <span class="n">Using</span> <span class="n">backend</span> <span class="n">LokyBackend</span> <span class="k">with</span> <span class="mi">16</span> <span class="n">concurrent</span> <span class="n">workers</span><span class="o">.</span>
<span class="p">[</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]:</span> <span class="n">Done</span>  <span class="mi">18</span> <span class="n">tasks</span>      <span class="o">|</span> <span class="n">elapsed</span><span class="p">:</span>  <span class="mf">3.3</span><span class="nb">min</span>
<span class="p">[</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]:</span> <span class="n">Done</span>  <span class="mi">90</span> <span class="n">out</span> <span class="n">of</span>  <span class="mi">90</span> <span class="o">|</span> <span class="n">elapsed</span><span class="p">:</span> <span class="mf">12.3</span><span class="nb">min</span> <span class="n">finished</span>
<span class="n">Best</span><span class="p">:</span> <span class="mf">0.999919</span> <span class="n">using</span> <span class="p">{</span><span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>
<span class="mf">0.999887</span> <span class="p">(</span><span class="mf">0.000126</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
<span class="mf">0.999919</span> <span class="p">(</span><span class="mf">0.000081</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>
<span class="mf">0.999903</span> <span class="p">(</span><span class="mf">0.000107</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">}</span>
<span class="mf">0.999919</span> <span class="p">(</span><span class="mf">0.000108</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">}</span>
<span class="mf">0.999919</span> <span class="p">(</span><span class="mf">0.000108</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<span class="mf">0.999903</span> <span class="p">(</span><span class="mf">0.000107</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">}</span>
<span class="mf">0.999903</span> <span class="p">(</span><span class="mf">0.000107</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">}</span>
<span class="mf">0.999903</span> <span class="p">(</span><span class="mf">0.000107</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">}</span>
<span class="mf">0.999887</span> <span class="p">(</span><span class="mf">0.000103</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
</code></pre></div>
                <p>Độ chính xác của model đạt được bằng 0.999919 tại điểm <code>subsample</code> = 0.2, hay subset của mỗi model = 30% <code>train set</code>.</p>
                <p>Đồ thị bên dưới thể hiện mối quan hệ giữa <code>subsample</code> và <code>accuracy</code>.</p>


                <div style="text-align:center">
                    <img src="/subsample.png">
                </div>


                <p><strong>2. Tuning Column Subsampling by Tree</strong></p>
                <p>Chúng ta cũng có thể tạo ra một tập ngẫu nhiên các <code>input features</code> để sử dụng cho mỗi <code>decision tree</code>. Trong XGBoost, điều này được cấu hình thông qua tham số <code>colsample_tree</code>. Giá trị mặc định của nó
                    là 1, tức là tất cả các <code>input features</code> đều được sử dụng cho mỗi tree.</p>
                <p>Ta sẽ thử tune tham số này với tập giá trị như sau: <strong>[0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 1.0]</strong></p>
                <p>Code đầy đủ:</p>
                <div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># XGBoost on Otto dataset, tune colsample_bytree</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">read_csv</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>

<span class="c1"># load data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;train.csv&#39;</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># split data into X and y</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">94</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[:,</span><span class="mi">94</span><span class="p">]</span>

<span class="c1"># encode string class values as integers</span>
<span class="n">label_encoded_y</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># grid search</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">()</span>
<span class="n">colsample_bytree</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">colsample_bytree</span><span class="o">=</span><span class="n">colsample_bytree</span><span class="p">)</span>
<span class="n">kfold</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s2">&#34;accuracy&#34;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kfold</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">grid_result</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">label_encoded_y</span><span class="p">)</span>

<span class="c1"># summarize results</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Best: </span><span class="si">%f</span><span class="s2"> using </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">grid_result</span><span class="o">.</span><span class="n">best_score_</span><span class="p">,</span> <span class="n">grid_result</span><span class="o">.</span><span class="n">best_params_</span><span class="p">))</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">grid_result</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;mean_test_score&#39;</span><span class="p">]</span>
<span class="n">stds</span> <span class="o">=</span> <span class="n">grid_result</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;std_test_score&#39;</span><span class="p">]</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">grid_result</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stdev</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%f</span><span class="s2"> (</span><span class="si">%f</span><span class="s2">) with: </span><span class="si">%r</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">stdev</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span>

<span class="c1"># plot</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">colsample_bytree</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">stds</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;XGBoost colsample_bytree vs accuracy&#34;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;colsample_bytree&#39;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;colsample_bytree.png&#39;</span><span class="p">)</span>
</code></pre></div>
                <p>Kết quả:</p>
                <div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">Fitting</span> <span class="mi">10</span> <span class="n">folds</span> <span class="k">for</span> <span class="n">each</span> <span class="n">of</span> <span class="mi">9</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">totalling</span> <span class="mi">90</span> <span class="n">fits</span>
<span class="p">[</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]:</span> <span class="n">Using</span> <span class="n">backend</span> <span class="n">LokyBackend</span> <span class="k">with</span> <span class="mi">16</span> <span class="n">concurrent</span> <span class="n">workers</span><span class="o">.</span>
<span class="p">[</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]:</span> <span class="n">Done</span>  <span class="mi">18</span> <span class="n">tasks</span>      <span class="o">|</span> <span class="n">elapsed</span><span class="p">:</span>  <span class="mf">3.0</span><span class="nb">min</span>
<span class="p">[</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]:</span> <span class="n">Done</span>  <span class="mi">90</span> <span class="n">out</span> <span class="n">of</span>  <span class="mi">90</span> <span class="o">|</span> <span class="n">elapsed</span><span class="p">:</span> <span class="mf">10.6</span><span class="nb">min</span> <span class="n">finished</span>
<span class="n">Best</span><span class="p">:</span> <span class="mf">0.999887</span> <span class="n">using</span> <span class="p">{</span><span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
<span class="mf">0.998578</span> <span class="p">(</span><span class="mf">0.000484</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
<span class="mf">0.999855</span> <span class="p">(</span><span class="mf">0.000152</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>
<span class="mf">0.999871</span> <span class="p">(</span><span class="mf">0.000121</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">}</span>
<span class="mf">0.999871</span> <span class="p">(</span><span class="mf">0.000121</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">}</span>
<span class="mf">0.999871</span> <span class="p">(</span><span class="mf">0.000121</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<span class="mf">0.999871</span> <span class="p">(</span><span class="mf">0.000121</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">}</span>
<span class="mf">0.999871</span> <span class="p">(</span><span class="mf">0.000121</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">}</span>
<span class="mf">0.999871</span> <span class="p">(</span><span class="mf">0.000121</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">}</span>
<span class="mf">0.999887</span> <span class="p">(</span><span class="mf">0.000103</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
</code></pre></div>
                <p>Độ chính xác của XGBoost đạt được là 0.999887 tại colsample_bytree = 1.0. Điều này có nghĩa rằng trong trường hợp này, <code>subsampling column</code> không mang lại giá trị nào.</p>
                <p>Đồ thị thể hiện mối quan hệ giữa <code>subsampling column</code> và <code>accuracy</code>.</p>


                <div style="text-align:center">
                    <img src="/colsample_bytree.png">
                </div>


                <p><strong>3. Tuning Column Subsampling by Split</strong></p>
                <p>Thay vì <code>subsampling column</code> cho mỗi tree, ta có thể <code>subsampling column</code> ở mức node (hay <em>Split</em>). Tức là tại mỗi node, ta sẽ <code>subsampling column</code> để tìm ra 1 tập ngẫu nhiên các <code>input features</code>                    để quyết định hướng đi tiếp theo. Đây chính là điểm khác biệt giữa <code>Random Forest</code> và <code>Bagging meta-data</code> mà ta đã đề cập đến trong bài 2 của chuỗi các bài viết về XGBoost.</p>
                <p><code>Subsampling column</code> ở mức node được cấu hình thông qua tham số <code>colsample_bylevel</code>. Ta sẽ tiến hành tune tham số này với giá trị thay đổi từ 10% đến giá trị mặc định ban đầu của nó (100%).</p>
                <p>Code đầy đủ như bên dưới:</p>
                <div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># XGBoost on Otto dataset, tune colsample_bylevel</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">read_csv</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>

<span class="c1"># load data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;train.csv&#39;</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># split data into X and y</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">94</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[:,</span><span class="mi">94</span><span class="p">]</span>

<span class="c1"># encode string class values as integers</span>
<span class="n">label_encoded_y</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># grid search</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">()</span>
<span class="n">colsample_bylevel</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">colsample_bylevel</span><span class="o">=</span><span class="n">colsample_bylevel</span><span class="p">)</span>
<span class="n">kfold</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s2">&#34;accuracy&#34;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kfold</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">grid_result</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">label_encoded_y</span><span class="p">)</span>

<span class="c1"># summarize results</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Best: </span><span class="si">%f</span><span class="s2"> using </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">grid_result</span><span class="o">.</span><span class="n">best_score_</span><span class="p">,</span> <span class="n">grid_result</span><span class="o">.</span><span class="n">best_params_</span><span class="p">))</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">grid_result</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;mean_test_score&#39;</span><span class="p">]</span>
<span class="n">stds</span> <span class="o">=</span> <span class="n">grid_result</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;std_test_score&#39;</span><span class="p">]</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">grid_result</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stdev</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%f</span><span class="s2"> (</span><span class="si">%f</span><span class="s2">) with: </span><span class="si">%r</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">stdev</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span>

<span class="c1"># plot</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">colsample_bylevel</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">stds</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;XGBoost colsample_bylevel vs accuracy&#34;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;colsample_bylevel&#39;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;colsample_bylevel.png&#39;</span><span class="p">)</span>
</code></pre></div>
                <p>Kết quả:</p>
                <div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">Fitting</span> <span class="mi">10</span> <span class="n">folds</span> <span class="k">for</span> <span class="n">each</span> <span class="n">of</span> <span class="mi">9</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">totalling</span> <span class="mi">90</span> <span class="n">fits</span>
<span class="p">[</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]:</span> <span class="n">Using</span> <span class="n">backend</span> <span class="n">LokyBackend</span> <span class="k">with</span> <span class="mi">16</span> <span class="n">concurrent</span> <span class="n">workers</span><span class="o">.</span>
<span class="p">[</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]:</span> <span class="n">Done</span>  <span class="mi">18</span> <span class="n">tasks</span>      <span class="o">|</span> <span class="n">elapsed</span><span class="p">:</span>  <span class="mf">2.6</span><span class="nb">min</span>
<span class="p">[</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]:</span> <span class="n">Done</span>  <span class="mi">90</span> <span class="n">out</span> <span class="n">of</span>  <span class="mi">90</span> <span class="o">|</span> <span class="n">elapsed</span><span class="p">:</span>  <span class="mf">9.3</span><span class="nb">min</span> <span class="n">finished</span>
<span class="n">Best</span><span class="p">:</span> <span class="mf">0.999919</span> <span class="n">using</span> <span class="p">{</span><span class="s1">&#39;colsample_bylevel&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">}</span>
<span class="mf">0.999903</span> <span class="p">(</span><span class="mf">0.000129</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bylevel&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
<span class="mf">0.999903</span> <span class="p">(</span><span class="mf">0.000079</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bylevel&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>
<span class="mf">0.999919</span> <span class="p">(</span><span class="mf">0.000081</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bylevel&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">}</span>
<span class="mf">0.999903</span> <span class="p">(</span><span class="mf">0.000107</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bylevel&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">}</span>
<span class="mf">0.999887</span> <span class="p">(</span><span class="mf">0.000103</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bylevel&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<span class="mf">0.999903</span> <span class="p">(</span><span class="mf">0.000107</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bylevel&#39;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">}</span>
<span class="mf">0.999903</span> <span class="p">(</span><span class="mf">0.000107</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bylevel&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">}</span>
<span class="mf">0.999871</span> <span class="p">(</span><span class="mf">0.000121</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bylevel&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">}</span>
<span class="mf">0.999887</span> <span class="p">(</span><span class="mf">0.000103</span><span class="p">)</span> <span class="k">with</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colsample_bylevel&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
</code></pre></div>
                <p><code>colsample_bylevel</code> = 0.3 cho ta model với độ chính xác cao nhất, 0.999919.</p>
                <p>Đồ thị thể hiện mối quan hệ giữa <code>colsample_bylevel</code> và <code>accuracy</code>.</p>


                <div style="text-align:center">
                    <img src="/colsample_bylevel.png">
                </div>


                <p><strong>6. Kết luận</strong></p>
                <p>Như vậy là chúng ta đã biêt cách tuning các kỹ thuật <code>subsample</code> hay <code>stochastic gradient boosting</code> của XGBoost. Nếu có phần cứng đủ mạnh, các bạn có thể tune tất cả các tham số đồng thời với nhau. Khi đó, độ chính
                    xác của model có thể tăng lên 1 chút. Nhưng cái giá phải trả là thời gian train sẽ rất lâu. :D</p>
                <p>Đây cũng là bài cuối cùng trong loạt bài viết về XGBoost model. Hi vọng qua những bài viết của mình, các bạn có thể hiểu hơn về XGBoost và tự tin hơn khi làm viêc với nó. Hẹn mọi người ở những chủ để tiếp theo! :)</p>
                <p><em>Toàn bộ source code của bài này các bạn có thể tham khảo trên github cá nhân của mình tại <a href="https://github.com/tiensu/xgboost-algorithm/tree/master/tune_subsample">github.</a></em></p>
                <p>Bài viết có tham khảo tại <a href="https://machinelearningmastery.com/XGBoost-with-python/">tham khảo</a>.</p>

            </div>
            <div class="info post_meta">
                <time datetime=2020-10-15T00:00:00Z class="date">Thursday, October 15, 2020</time>

                <ul class="tags">

                    <li> <a href="https://tiensu.github.io/tags/ai">AI</a> </li>

                    <li> <a href="https://tiensu.github.io/tags/ml">ML</a> </li>

                    <li> <a href="https://tiensu.github.io/tags/xgboost">XGBoost</a> </li>

                </ul>


            </div>
            <div class="clearfix"></div>
        </article>

        <div class="other_posts">

            <a href="https://tiensu.github.io/posts/xgboost/15_tuning_learning_rate_and_number_decition_tree/" class="prev">XGBoost - Bài 13: Tuning Learning_Rate và số lượng của Decision Tree</a>


            <a href="https://tiensu.github.io/posts/17_data_scientist_theory_and_real/" class="next">Nghề Data Scientis - Lý thuyết và thực tế - Sự khác biêt</a>

        </div>
        <aside id="comments">
        </aside>


    </section>

    <a id="back_to_top" title="Go To Top" href="#">
        <span>
    <svg viewBox="0 0 24 24">
      <path fill="none" d="M0 0h24v24H0z"></path>
      <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"></path>
    </svg>
  </span>
    </a>

    <footer id="footer">
        <p>
            <span>&copy; 2020 <a href="https://tiensu.github.io/" title="ML in Practical">ML in Practical</a> </span>
            <span>Built with <a rel="nofollow" target="_blank" href="https://gohugo.io">Hugo</a></span>
            <span>Theme by <a rel="nofollow" target="_blank" href="https://github.com/wayjam/hugo-theme-mixedpaper">WayJam</a></span>
        </p>
        <script src="https://tiensu.github.io/js/main.min.8b182175f5874aeed0acc0979345c98d4bde22208ec4f36cc1d6e3102acb4b10.js" integrity="sha256-ixghdfWHSu7QrMCXk0XJjUveIiCOxPNswdbjECrLSxA=" crossorigin="anonymous" async></script>
    </footer>

</body>

</html>